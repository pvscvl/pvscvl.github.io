<html><head><title>[Chapter 13] A Miscellany of Scripts</TITLE
><meta name="DC.title" content="sed &amp; awk"><meta name="DC.creator" content="Dale Dougherty &amp; Arnold Robbins"><meta name="DC.publisher" content="O'Reilly &amp; Associates, Inc."><meta name="DC.date" content="1998-08-03T21:04:59Z"><meta name="DC.type" content="Text.Monograph"><meta name="DC.format" content="text/html" scheme="MIME"><meta name="DC.source" content="1-56592-225-5" scheme="ISBN"><meta name="DC.language" content="en-US"><meta name="generator" content="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><link rev="made" href="mailto:online-books@oreilly.com" title="Online Books Comments"><link rel="up" href="index.htm" webstripperlinkwas="http://www.ms.itb.ac.id/buku/unix-bookshelf/sedawk/index.htm" title="sed &amp; awk"><link rel="prev" href="ch12_03.htm" webstripperlinkwas="ch12_03.htm" title="12.3 Spare Details of the masterindex Program"><link rel="next" href="ch13_02.htm" webstripperlinkwas="ch13_02.htm" title="13.2 phonebill&nbsp;- Track Phone Usage"></HEAD
><body bgcolor="#FFFFFF" text="#000000"><div class="htmlnav"><h1><img src="gifs/smbanner.gif" webstripperlinkwas="gifs/smbanner.gif" alt="sed &amp; awk" usemap="#srchmap" border="0"></H1
><map name="srchmap"><area shape="RECT" coords="0,0,466,65" href="index.htm" webstripperlinkwas="http://www.ms.itb.ac.id/buku/unix-bookshelf/sedawk/index.htm" alt="sed &amp; awk"><area shape="RECT" coords="467,0,514,18" href="jobjects/fsearch.htm" webstripperlinkwas="jobjects/fsearch.htm" alt="Search this book"></MAP
><table width="515" border="0" cellspacing="0" cellpadding="0"><tr><td align="LEFT" valign="TOP" width="172"><a class="SECT1" href="ch12_03.htm" webstripperlinkwas="ch12_03.htm" title="12.3 Spare Details of the masterindex Program"><img src="../gifs/txtpreva.gif" webstripperlinkwas="../gifs/txtpreva.gif" alt="Previous: 12.3 Spare Details of the masterindex Program" border="0"></A
></TD
><td align="CENTER" valign="TOP" width="171"><b><font face="ARIEL,HELVETICA,HELV,SANSERIF" size="-1">Chapter 13</FONT
></B
></TD
><td align="RIGHT" valign="TOP" width="172"><a class="SECT1" href="ch13_02.htm" webstripperlinkwas="ch13_02.htm" title="13.2 phonebill&nbsp;- Track Phone Usage"><img src="../gifs/txtnexta.gif" webstripperlinkwas="../gifs/txtnexta.gif" alt="Next: 13.2 phonebill&nbsp;- Track Phone Usage" border="0"></A
></TD
></TR
></TABLE
>&nbsp;<hr align="LEFT" width="515" title="footer"></DIV
><div class="CHAPTER"><h1 class="chapter"><a class="title" name="SEDAWK-CH-13">13. A Miscellany of Scripts</A
></H1
><div class="htmltoc"><p><b>Contents:</B
><br><a class="sect1" href="#AUTOID-11215" title="13.1 uutot.awk&nbsp;- Report UUCP Statistics">uutot.awk&nbsp;- Report UUCP Statistics</A
><br><a class="sect1" href="ch13_02.htm" webstripperlinkwas="ch13_02.htm" title="13.2 phonebill&nbsp;- Track Phone Usage">phonebill&nbsp;- Track Phone Usage</A
><br><a class="sect1" href="ch13_03.htm" webstripperlinkwas="ch13_03.htm" title="13.3 combine&nbsp;- Extract Multipart uuencoded Binaries">combine&nbsp;- Extract Multipart uuencoded Binaries</A
><br><a class="sect1" href="ch13_04.htm" webstripperlinkwas="ch13_04.htm" title="13.4 mailavg&nbsp;- Check Size of Mailboxes">mailavg&nbsp;- Check Size of Mailboxes</A
><br><a class="sect1" href="ch13_05.htm" webstripperlinkwas="ch13_05.htm" title="13.5 adj&nbsp;- Adjust Lines for Text Files">adj&nbsp;- Adjust Lines for Text Files</A
><br><a class="sect1" href="ch13_06.htm" webstripperlinkwas="ch13_06.htm" title="13.6 readsource&nbsp;- Format Program Source Files for troff">readsource&nbsp;- Format Program Source Files for troff</A
><br><a class="sect1" href="ch13_07.htm" webstripperlinkwas="ch13_07.htm" title="13.7 gent&nbsp;- Get a termcap Entry">gent&nbsp;- Get a termcap Entry</A
><br><a class="sect1" href="ch13_08.htm" webstripperlinkwas="ch13_08.htm" title="13.8 plpr&nbsp;- lpr Preprocessor">plpr&nbsp;- lpr Preprocessor</A
><br><a class="sect1" href="ch13_09.htm" webstripperlinkwas="ch13_09.htm" title="13.9 transpose&nbsp;- Perform a Matrix Transposition">transpose&nbsp;- Perform a Matrix Transposition</A
><br><a class="sect1" href="ch13_10.htm" webstripperlinkwas="ch13_10.htm" title="13.10 m1&nbsp;- Simple Macro Processor">m1&nbsp;- Simple Macro Processor</A
></P
><p></P
></DIV
><p class="para">This chapter contains a miscellany of scripts contributed by Usenet
users.<a class="indexterm" name="CH13.SCRIPT"></A
>
Each program is introduced with a brief description
by the program's author.
Our comments are placed inside brackets [like this].
Then the full program listing is shown.  If the author
did not supply an example, we generate one 
and describe it after the listing. 
Finally, in a section called &quot;Program Notes,&quot;
we talk briefly about the program, highlighting some interesting points.
Here is a summary of the scripts:

<dl class="variablelist"><dt class="term"><kbd class="command">uutot.awk</KBD
></DT
><dd class="listitem"><p class="para">Report UUCP statistics.</P
></DD
><dt class="term"><kbd class="command">phonebill</KBD
></DT
><dd class="listitem"><p class="para">Track phone usage.</P
></DD
><dt class="term"><kbd class="command">combine</KBD
></DT
><dd class="listitem"><p class="para">Extract multipart uuencoded binaries.</P
></DD
><dt class="term"><kbd class="command">mailavg</KBD
></DT
><dd class="listitem"><p class="para">Check size of mailboxes.</P
></DD
><dt class="term"><kbd class="command">adj</KBD
></DT
><dd class="listitem"><p class="para">Adjust lines for text files.</P
></DD
><dt class="term"><kbd class="command">readsource</KBD
></DT
><dd class="listitem"><p class="para">Format program source files for <kbd class="command">troff</KBD
>.</P
></DD
><dt class="term"><kbd class="command">gent</KBD
></DT
><dd class="listitem"><p class="para">Get a termcap entry.</P
></DD
><dt class="term"><kbd class="command">plpr</KBD
></DT
><dd class="listitem"><p class="para"><kbd class="command">lpr</KBD
> preprocessor.</P
></DD
><dt class="term"><kbd class="command">transpose</KBD
></DT
><dd class="listitem"><p class="para">Perform a matrix transposition.</P
></DD
><dt class="term"><kbd class="command">m1</KBD
></DT
><dd class="listitem"><p class="para">A very simple macro processor.</P
></DD
></DL
></P
><div class="sect1"><h2 class="sect1"><a class="title" name="AUTOID-11215">13.1 uutot.awk&nbsp;- Report UUCP Statistics</A
></H2
><p class="para"><em class="emphasis">Contributed by Roger A. Cornelius</EM
></P
><p class="para"><a class="indexterm" name="CH13.UUTOT"></A
>Here's something I wrote in nawk in response to all the C versions 
of the same thing which were posted to <em class="emphasis">alt.sources</EM
> awhile back.
Basically, it summarizes statistics of <kbd class="command">uucp</KBD
> connections (connect time,
throughput, files transmitted, etc.).  It only supports HDB-style log
files, but will show statistics on a site-by-site, or on an overall
(all sites), basis.
[It also works with <i class="filename">/usr/spool/uucp/SYSLOG</I
>.]</P
><p class="para">I use a shell wrapper which calls &quot;awk -f&quot; to run this, but it's not
necessary.  Usage information is in the header.
(Sorry about the lack of comments.)</P
><blockquote class="screen"><pre class="screen"># @(#) uutot.awk - display uucp statistics - requires new awk
# @(#) Usage:awk -f uutot.awk [site ...] /usr/spool/uucp/.Admin/xferstats
# Author: Roger A. Cornelius (rac@sherpa.uucp)

#       dosome[];               # site names to work for - all if not set
#       remote[];               # array of site names
#       bytes[];                # bytes xmitted by site
#       time[];	               # time spent by site
#       files[];                # files xmitted by site
BEGIN {
	doall = 1;
	if (ARGC &gt; 2) {
		doall = 0;
		for (i = 1; i &lt; ARGC-1; i++) {
			dosome[ ARGV[i] ];
			ARGV[i] = &quot;&quot;;
		}
	}

	kbyte = 1024	# 1000 if you're not picky
	bang = &quot;!&quot;;
	sending = &quot;-&gt;&quot;;
	xmitting = &quot;-&gt;&quot; &quot;|&quot; &quot;&lt;-&quot;;

	hdr1 = &quot;Remote     K-Bytes   K-Bytes   K-Bytes &quot; \
		&quot;Hr:Mn:Sc Hr:Mn:Sc AvCPS AvCPS    #    #\n&quot;;
	hdr2 = &quot;SiteName      Recv      Xmit     Total     &quot; \
		&quot;Recv     Xmit  Recv  Xmit Recv Xmit\n&quot;;
	hdr3 = &quot;-------- --------- --------- --------- -------- &quot; \
		&quot;-------- ----- ----- ---- ----&quot;;
	fmt1 = &quot;%-8.8s %9.3f %9.3f %9.3f %2d:%02d:%02.0f &quot; \
		&quot;%2d:%02d:%02.0f %5.0f %5.0f %4d %4d\n&quot;;
	fmt2 = &quot;Totals   %9.3f %9.3f %9.3f %2d:%02d:%02.0f &quot; \
		&quot;%2d:%02d:%02.0f %5.0f %5.0f %4d %4d\n&quot;;
}
{
	if ($6 !~ xmitting)		# should never be
		next;
	direction = ($6 == sending ? 1 : 2)

	site = substr($1,1,index($1,bang)-1);
	if (site in dosome || doall) {
		remote[site];
		bytes[site,direction] += $7;
		time[site,direction] += $9;
		files[site,direction]++;
	}
}
END {
	print hdr1 hdr2 hdr3;
	for (k in remote) {
		rbyte += bytes[k,2];	sbyte += bytes[k,1];
		rtime += time[k,2];	stime += time[k,1];
		rfiles += files[k,2];	sfiles += files[k,1];
		printf(fmt1, k, bytes[k,2]/kbyte, bytes[k,1]/kbyte,
			(bytes[k,2]+bytes[k,1])/kbyte,
			time[k,2]/3600, (time[k,2]%3600)/60, time[k,2]%60,
			time[k,1]/3600, (time[k,1]%3600)/60, time[k,1]%60,
			bytes[k,2] &amp;&amp; time[k,2] ? bytes[k,2]/time[k,2] : 0,
			bytes[k,1] &amp;&amp; time[k,1] ? bytes[k,1]/time[k,1] : 0,
			files[k,2], files[k,1]);
	}

	print hdr3
	printf(fmt2, rbyte/kbyte, sbyte/kbyte, (rbyte+sbyte)/kbyte,
		rtime/3600, (rtime%3600)/60, rtime%60,
		stime/3600, (stime%3600)/60, stime%60,
		rbyte &amp;&amp; rtime ? rbyte/rtime : 0,
		sbyte &amp;&amp; stime ? sbyte/stime : 0,
		rfiles, sfiles);
}</PRE
></BLOCKQUOTE
><p class="para">A test file was generated to test Cornelius' program. 
Here are a few lines extracted
from <i class="filename">/usr/spool/uucp/.Admin/xferstats</I
> (because
each line in this file is too long to print on a page, we have broken
the line following the directional arrow for display purposes only):</P
><blockquote class="screen"><pre class="screen">isla!nuucp S (8/3-16:10:17) (C,126,25) [ttyi1j] -&gt;
                     1131/4.880 secs, 231 bytes/sec
isla!nuucp S (8/3-16:10:20) (C,126,26) [ttyi1j] -&gt;
                     149/0.500 secs, 298 bytes/sec
isla!sue S (8/3-16:10:49) (C,126,27) [ttyi1j] -&gt;
                     646/25.230 secs, 25 bytes/sec
isla!sue S (8/3-16:10:52) (C,126,28) [ttyi1j] -&gt;
                     145/0.510 secs, 284 bytes/sec
uunet!uisla M (8/3-16:15:50) (C,951,1) [cui1a] -&gt;
                     1191/0.660 secs, 1804 bytes/sec
uunet!uisla M (8/3-16:15:53) (C,951,2) [cui1a] -&gt;
                     148/0.080 secs, 1850 bytes/sec
uunet!uisla M (8/3-16:15:57) (C,951,3) [cui1a] -&gt;
                     1018/0.550 secs, 1850 bytes/sec
uunet!uisla M (8/3-16:16:00) (C,951,4) [cui1a] -&gt;
                     160/0.070 secs, 2285 bytes/sec
uunet!daemon M (8/3-16:16:06) (C,951,5) [cui1a] &lt;-
                     552/2.740 secs, 201 bytes/sec
uunet!daemon M (8/3-16:16:09) (C,951,6) [cui1a] &lt;-
                     102/1.390 secs, 73 bytes/sec</PRE
></BLOCKQUOTE
><p class="para">Note that there are 12 fields; however, the program really only
uses fields 1, 6, 7, and 9.
Running the program on the sample input produces the following results:</P
><blockquote class="screen"><pre class="screen">$ <code class="userinput"><b>nawk -f uutot.awk uutot.test</B
></CODE
>
Remote     K-Bytes   K-Bytes   K-Bytes Hr:Mn:Sc Hr:Mn:Sc AvCPS AvCPS    #    #
SiteName      Recv      Xmit     Total     Recv     Xmit  Recv  Xmit Recv Xmit
-------- --------- --------- --------- -------- -------- ----- ----- ---- ----
uunet        0.639     2.458     3.097  0:04:34  2:09:49     2     0    2    4
isla         0.000     2.022     2.022  0:00:00  0:13:58     0     2    0    4
-------- --------- --------- --------- -------- -------- ----- ----- ---- ----
Totals       0.639     4.480     5.119  0:04:34  2:23:47     2     1    2    8</PRE
></BLOCKQUOTE
><div class="sect2"><h3 class="sect2"><a class="title" name="SEDAWK-CH-13-SECT-0.0.0.1">13.1.1 Program Notes for uutot.awk</A
></H3
><p class="para">This nawk application is an excellent example of a clearly written
awk program. 
It is also a typical example of using awk to change a rather
obscure UNIX log into a useful report.</P
><p class="para">Although Cornelius apologizes for the lack of comments that explain
the logic of the program, the usage of the program is clear
from the initial comments.  Also, he uses
variables to define search patterns and the report's layout.
This helps to simplify conditional and print statements in
the body of the program.
It also helps that the variables have names which aid
in immediately recognizing their purpose.</P
><p class="para">This program has a three-part structure, as
we emphasized in <a class="xref" href="ch07_01.htm" webstripperlinkwas="ch07_01.htm" title="Writing Scripts for awk">Chapter 7, Writing Scripts for awk</A
>.  It consists of a <kbd class="command">BEGIN</KBD
>
procedure, in which variables are defined; the body,
in which each line of data from the log file is processed;
and the <kbd class="command">END</KBD
> procedure, in which the output for the report
is generated.</P
></DIV
><a class="indexterm" name="AUTOID-11241"></A
></DIV
></DIV
><div class="htmlnav"><p></P
><hr align="LEFT" width="515" title="footer"><table width="515" border="0" cellspacing="0" cellpadding="0"><tr><td align="LEFT" valign="TOP" width="172"><a class="SECT1" href="ch12_03.htm" webstripperlinkwas="ch12_03.htm" title="12.3 Spare Details of the masterindex Program"><img src="../gifs/txtpreva.gif" webstripperlinkwas="../gifs/txtpreva.gif" alt="Previous: 12.3 Spare Details of the masterindex Program" border="0"></A
></TD
><td align="CENTER" valign="TOP" width="171"><a class="book" href="index.htm" webstripperlinkwas="http://www.ms.itb.ac.id/buku/unix-bookshelf/sedawk/index.htm" title="sed &amp; awk"><img src="../gifs/txthome.gif" webstripperlinkwas="../gifs/txthome.gif" alt="sed &amp; awk" border="0"></A
></TD
><td align="RIGHT" valign="TOP" width="172"><a class="SECT1" href="ch13_02.htm" webstripperlinkwas="ch13_02.htm" title="13.2 phonebill&nbsp;- Track Phone Usage"><img src="../gifs/txtnexta.gif" webstripperlinkwas="../gifs/txtnexta.gif" alt="Next: 13.2 phonebill&nbsp;- Track Phone Usage" border="0"></A
></TD
></TR
><tr><td align="LEFT" valign="TOP" width="172">12.3 Spare Details of the masterindex Program</TD
><td align="CENTER" valign="TOP" width="171"><a class="index" href="index/idx_0.htm" webstripperlinkwas="index/idx_0.htm" title="Book Index"><img src="../gifs/index.gif" webstripperlinkwas="../gifs/index.gif" alt="Book Index" border="0"></A
></TD
><td align="RIGHT" valign="TOP" width="172">13.2 phonebill&nbsp;- Track Phone Usage</TD
></TR
></TABLE
><hr align="LEFT" width="515" title="footer"><img src="../gifs/smnavbar.gif" webstripperlinkwas="../gifs/smnavbar.gif" usemap="#map" border="0" alt="The UNIX CD Bookshelf Navigation"><map name="map"><area shape="RECT" coords="0,0,73,21" href="../index.html" webstripperlinkwas="http://www.ms.itb.ac.id/buku/unix-bookshelf/index.html" alt="The UNIX CD Bookshelf"><area shape="RECT" coords="74,0,163,21" href="../upt/index.htm" webstripperlinkwas="http://www.ms.itb.ac.id/buku/unix-bookshelf/upt/index.htm" alt="UNIX Power Tools"><area shape="RECT" coords="164,0,257,21" href="../unixnut/index.htm" webstripperlinkwas="http://www.ms.itb.ac.id/buku/unix-bookshelf/unixnut/index.htm" alt="UNIX in a Nutshell"><area shape="RECT" coords="258,0,321,21" href="../vi/index.htm" webstripperlinkwas="http://www.ms.itb.ac.id/buku/unix-bookshelf/vi/index.htm" alt="Learning the vi Editor"><area shape="RECT" coords="322,0,378,21" href="index.htm" webstripperlinkwas="http://www.ms.itb.ac.id/buku/unix-bookshelf/sedawk/index.htm" alt="sed &amp; awk"><area shape="RECT" coords="379,0,438,21" href="../ksh/index.htm" webstripperlinkwas="http://www.ms.itb.ac.id/buku/unix-bookshelf/ksh/index.htm" alt="Learning the Korn Shell"><area shape="RECT" coords="439,0,514,21" href="../lrnunix/index.htm" webstripperlinkwas="http://www.ms.itb.ac.id/buku/unix-bookshelf/lrnunix/index.htm" alt="Learning the UNIX Operating System"></MAP
></DIV
></BODY
></HTML
>
