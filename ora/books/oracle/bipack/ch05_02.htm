<HTML
><HEAD
><TITLE
>[Chapter 5] 5.2 Getting Started with Oracle AQ</TITLE
><META
NAME="DC.Creator"
CONTENT="Steven Feuerstein, Charles Dye &amp; John Beresniewicz"><META
NAME="DC.Date"
CONTENT="2000-04-29T17:50:00Z"><META
NAME="DC.Format"
CONTENT="text/html"
SCHEME="MIME"><META
NAME="DC.Identifier"
CONTENT="O'Reilly and Associates-1-56592-375-8E"><META
NAME="DC.Language"
CONTENT="en-US"><META
NAME="DC.Publisher"
CONTENT="O'Reilly &amp; Associates, Inc."><META
NAME="DC.Source"
CONTENT="1-56592-375-8E"
SCHEME="ISBN"><META
NAME="DC.Subject.Keyword"
CONTENT="Oracle Packages"><META
NAME="DC.Title"
CONTENT="Oracle Built-in Packages"><META
NAME="DC.Type"
CONTENT="Text.Monograph"><META
NAME="generator"
CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINK
REL="stylesheet"
TYPE="text/css"
HREF="../style/style1.css"><LINK
REV="made"
HREF="mailto:online-books@oreilly.com"
TITLE="Online Books Comments"><LINK
REL="up"
HREF="ch05_01.htm"
TITLE="5. Oracle Advanced Queuing"><LINK
REL="prev"
HREF="ch05_01.htm"
TITLE="5.1 Oracle AQ Concepts"><LINK
REL="next"
HREF="ch05_03.htm#ch05-SECT-3.1.1"
TITLE="5.3 Oracle AQ Nonprogram Elements"></HEAD
><BODY
><DIV
CLASS="htmlnav"
><H1
><IMG
SRC="gifs/smbanner.gif"
ALT="Oracle Built-in Packages"
USEMAP="#srchmap"
BORDER="0"></H1
><MAP
NAME="srchmap"
><AREA
SHAPE="RECT"
COORDS="0,0,466,65"
HREF="index.htm"
ALT="Oracle Built-in Packages"><AREA
SHAPE="RECT"
COORDS="467,0,514,18"
HREF="jobjects/fsearch.htm"
ALT="Search this book"></MAP
><TABLE
WIDTH="515"
BORDER="0"
CELLSPACING="0"
CELLPADDING="0"
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="172"
><A
CLASS="sect1"
HREF="ch05_01.htm"
TITLE="5.1 Oracle AQ Concepts"
><IMG
SRC="../gifs/txtpreva.gif"
ALT="Previous: 5.1 Oracle AQ Concepts"
BORDER="0"></A
></TD
><TD
ALIGN="CENTER"
VALIGN="TOP"
WIDTH="171"
><SPAN
CLASS="NAVTITLE"
><A
CLASS="chapter"
REL="up"
HREF="ch05_01.htm"
TITLE="5. Oracle Advanced Queuing"
>Chapter 5<BR>Oracle Advanced Queuing</A
></SPAN
></TD
><TD
ALIGN="RIGHT"
VALIGN="TOP"
WIDTH="172"
><A
CLASS="sect1"
HREF="ch05_03.htm#ch05-SECT-3.1.1"
TITLE="5.3 Oracle AQ Nonprogram Elements"
><IMG
SRC="../gifs/txtnexta.gif"
ALT="Next: 5.3 Oracle AQ Nonprogram Elements"
BORDER="0"></A
></TD
></TR
></TABLE
>&nbsp;<HR
ALIGN="LEFT"
WIDTH="515"
TITLE="footer"></DIV
><DIV
CLASS="sect1"
><H2
CLASS="sect1"
><A
CLASS="title"
NAME="ch05-12450"
>5.2 Getting Started with Oracle AQ</A
></H2
><P
CLASS="para"
>There are five basic steps involved in using Oracle AQ:</P
><OL
CLASS="orderedlist"
><LI
CLASS="listitem"
><P
CLASS="para"
>Install Oracle AQ for use in your database. For this, the underlying database objects must be created and the initialization file for the instance modified.</P
></LI
><LI
CLASS="listitem"
><P
CLASS="para"
>Authorize administrative and operational privileges on queues.</P
></LI
><LI
CLASS="listitem"
><P
CLASS="para"
>Set up the message queue tables and corresponding queues.</P
></LI
><LI
CLASS="listitem"
><P
CLASS="para"
>Enqueue messages to a queue.</P
></LI
><LI
CLASS="listitem"
><P
CLASS="para"
>Dequeue messages from a queue.</P
></LI
></OL
><P
CLASS="para"
>In many organizations, steps 1 through 3 will be performed by a database administrator. They require specific authorization and can be a complex process, depending on the type of queues you want to create. The fourth and fifth steps will be performed from within the PL/SQL programs that you have written to take advantage of this message queuing technology. </P
><P
CLASS="para"
>Steps 3, 4, and 5 are explained in detail later in this chapter. For now, let's take a look at the steps you must take to install AQ and to grant the proper privileges to Oracle accounts in order to perform AQ activities.</P
><DIV
CLASS="sect2"
><H3
CLASS="sect2"
><A
CLASS="title"
NAME="ch05-SECT-2.1"
>5.2.1 Installing the Oracle AQ Facility</A
></H3
><P
CLASS="para"
><A
CLASS="indexterm"
NAME="ch05-idx-15845-0"
></A
><A
CLASS="indexterm"
NAME="ch05-idx-15845-1"
></A
><A
CLASS="indexterm"
NAME="ch05-idx-15845-2"
></A
><A
CLASS="indexterm"
NAME="ch05-idx-15845-3"
></A
>Oracle Corporation has established the following guidelines for use of Oracle AQ:</P
><UL
CLASS="itemizedlist"
><LI
CLASS="listitem"
><P
CLASS="para"
><A
CLASS="indexterm"
NAME="ch05-idx-15847-0"
></A
>If you have a license to the Oracle8 Enterprise Edition with the Objects Option, then you will be able to take advantage of the full functionality of Oracle AQ.</P
></LI
><LI
CLASS="listitem"
><P
CLASS="para"
>If you have a license to the Oracle8 Enterprise Edition without the Objects option, then you will be able to use Oracle AQ with queues of type RAW only.</P
></LI
><LI
CLASS="listitem"
><P
CLASS="para"
>If you have a license to Oracle8 without the Enterprise Edition, you are not licensed to use Oracle AQ at all.</P
></LI
></UL
><P
CLASS="para"
>The DBMS_AQ and DBMS_AQADM packages (and the database object used by them) are created when the Oracle database is installed. You should not have to take any special steps to install Oracle AQ and make it available in your environment. (You will, as covered in a later section, need to grant access to Oracle AQ to specific users.)</P
><P
CLASS="para"
><A
CLASS="indexterm"
NAME="ch05-idx-15857-0"
></A
><A
CLASS="indexterm"
NAME="ch05-idx-15857-1"
></A
>Before you can execute any programs in the DBMS_AQADM or DBMS_AQ packages, you may need to grant EXECUTE <A
CLASS="indexterm"
NAME="ch05-idx-19377-0"
></A
>privilege on those packages explicitly (role-based privileges do not take effect inside stored code). If you have trouble executing any program in these packages, connect to the SYS account and execute these commands,</P
><BLOCKQUOTE
><PRE
CLASS="programlisting"
>GRANT EXECUTE ON DBMS_AQADM TO &lt;user&gt;;
GRANT EXECUTE ON DBMS_AQ TO &lt;user&gt;;</PRE
></BLOCKQUOTE
><P
CLASS="para"
>where &lt;user&gt; is the name of the account to which you want to grant EXECUTE privilege.</P
></DIV
><DIV
CLASS="sect2"
><H3
CLASS="sect2"
><A
CLASS="title"
NAME="ch05-22925"
>5.2.2 Database Initialization</A
></H3
><P
CLASS="para"
>You will need to set one or more initialization parameters in order to obtain the desired behavior from Oracle AQ.</P
><DIV
CLASS="sect3"
><H4
CLASS="sect3"
><A
CLASS="title"
NAME="ch05-SECT-2.2.1"
>5.2.2.1 Starting the <A
CLASS="indexterm"
NAME="ch05-idx-15858-0"
></A
>Queue Monitor</A
></H4
><P
CLASS="para"
>One of the features of Oracle AQ is the ability to manage the time in which messages are available for dequeueing and the time after which messages are "expired." If you want to employ this "time management" feature, you need to add a parameter to your initialization file or INIT.ORA file for your database instance. The name of this parameter is AQ_TM_PROCESSES, and it can be assigned a nonzero integer value. If the parameter is set to any number between 1 and 10, that number of Queue Monitor background processes will be created to monitor messages in the various queues.</P
><P
CLASS="para"
>The name of the process created is,</P
><BLOCKQUOTE
><PRE
CLASS="programlisting"
>ora_aqtm_&lt;oracle_SID&gt;</PRE
></BLOCKQUOTE
><P
CLASS="para"
>where oracle_SID is the System ID for the database instance being started. If the parameter is not specified or is set to 0, then the Queue Monitor background process will not be created.</P
><P
CLASS="para"
>Here is an example of a line in the INIT.ORA file that specifies that one Queue Monitor process be created:</P
><BLOCKQUOTE
><PRE
CLASS="programlisting"
>AQ_TM_PROCESSES = 1</PRE
></BLOCKQUOTE
><P
CLASS="para"
>If the Queue Monitor process it not started, you will not be able to start and stop the Queue Monitor using the DBMS_AQADM.START_TIME_MANAGER and DBMS_AQADM.STOP_TIME_MANAGER procedures, respectively.</P
></DIV
><DIV
CLASS="sect3"
><H4
CLASS="sect3"
><A
CLASS="title"
NAME="ch05-SECT-2.2.2"
>5.2.2.2 Starting propagation processes</A
></H4
><P
CLASS="para"
>Message <A
CLASS="indexterm"
NAME="ch05-idx-15860-0"
></A
>propagation (an Oracle 8.0.4 AQ feature) is implemented by job queue processes. The number of these processes is defined with the JOB_QUEUE_PROCESSES parameter. The default value for this parameter is 0. If you want message propagation to take place, you must set this parameter to at least 1. If you plan to propagate messages from many queues in your instance or receive messages to many destination queues, you (or your DBA) should set this parameter to a higher value. </P
><P
CLASS="para"
>Here is an example of a setting of this parameter to three processes:</P
><BLOCKQUOTE
><PRE
CLASS="programlisting"
>JOB_QUEUE_PROCESSES = 3</PRE
></BLOCKQUOTE
><P
CLASS="para"
>See <A
CLASS="xref"
HREF="ch12_01.htm"
>Chapter 12, <CITE
CLASS="chapter"
>Managing Server Resources</CITE
></A
>, for more information about DBMS_JOB and the setting of this parameter.</P
></DIV
><DIV
CLASS="sect3"
><H4
CLASS="sect3"
><A
CLASS="title"
NAME="ch05-SECT-2.2.3"
>5.2.2.3 Setting Oracle AQ compatibility</A
></H4
><P
CLASS="para"
><A
CLASS="indexterm"
NAME="ch05-idx-15863-0"
></A
><A
CLASS="indexterm"
NAME="ch05-idx-15863-1"
></A
>If you want to use the Oracle AQ<A
CLASS="indexterm"
NAME="ch05-idx-15864-0"
></A
> propagation feature, set your compatibility setting in the INIT.ORA file as follows:</P
><BLOCKQUOTE
><PRE
CLASS="programlisting"
>COMPATIBLE = 8.0.4</PRE
></BLOCKQUOTE
><P
CLASS="para"
>This parameter will be checked under any of the following conditions:</P
><UL
CLASS="itemizedlist"
><LI
CLASS="listitem"
><P
CLASS="para"
>If a call to the DBMS_AQADM.ADD_SUBSCRIBER procedure includes an agent (defined with the SYS.AQ$_AGENT object type) whose address field is non-NULL.</P
></LI
><LI
CLASS="listitem"
><P
CLASS="para"
>If an agent defined with the SYS.AQ$_AGENT object type whose address field is non-NULL is specified in the recipient list field of a message properties record in a call to the DBMS_AQ.ENQUEUE procedure.</P
></LI
><LI
CLASS="listitem"
><P
CLASS="para"
>If you call the DBMS_AQADM.SCHEDULE_PROPAGATION procedure.</P
></LI
></UL
><P
CLASS="para"
>You can also downgrade to 8.0.3 after you have used the Oracle 8.0.4 features by using the following command:</P
><BLOCKQUOTE
><PRE
CLASS="programlisting"
>ALTER DATABASE RESET COMPATIBILITY</PRE
></BLOCKQUOTE
><P
CLASS="para"
>Users will not be able to restart the database in 8.0.3 compatibility mode under the following conditions:</P
><UL
CLASS="itemizedlist"
><LI
CLASS="listitem"
><P
CLASS="para"
>If you have messages in queues that have not yet been propagated to their destination queues. </P
></LI
><LI
CLASS="listitem"
><P
CLASS="para"
>If there are propagation schedules still pending for execution. If this is the case, then you will probably need to run DBMS_AQADM.UNSCHEDULE_PROPAGATION to remove those schedules.</P
></LI
><LI
CLASS="listitem"
><P
CLASS="para"
>If you have queues with subscribers that specify remote destination (with a non-NULL address field in the agent). In this scenario, you will want to run DBMS_AQADM.REMOVE_SUBSCRIBER to remove the remote subscribers. </P
></LI
></UL
><P
CLASS="para"
>If you have been using Oracle AQ in Oracle 8.0.3 and are now upgrading to 8.0.4, check the online Oracle documentation for upgrade steps you must take. </P
></DIV
></DIV
><DIV
CLASS="sect2"
><H3
CLASS="sect2"
><A
CLASS="title"
NAME="ch05-SECT-2.3"
>5.2.3 Authorizing Accounts to Use Oracle AQ</A
></H3
><P
CLASS="para"
><A
CLASS="indexterm"
NAME="ch05-idx-15872-0"
></A
>When working with AQ, you will perform either administrative or operational activities. Administrative tasks include creating queue tables and queues, and starting and stopping queues. Operational tasks include different aspects of using existing queues (i.e., queuing messages to them and dequeuing messages from them). Access to these operations is granted to users through database roles. There are two such <A
CLASS="indexterm"
NAME="ch05-idx-15874-0"
></A
>roles:</P
><DL
CLASS="variablelist"
><DT
CLASS="term"
><A
CLASS="indexterm"
NAME="ch05-idx-15867-0"
></A
><A
CLASS="indexterm"
NAME="ch05-idx-15867-1"
></A
><A
CLASS="indexterm"
NAME="ch05-idx-15867-2"
></A
>AQ_ADMINISTRATOR_ROLE</DT
><DD
CLASS="listitem"
><P
CLASS="para"
>This role grants EXECUTE privileges for all programs in DBMS_AQ and DBMA_AQADM. The user SYS must grant this role to the account(s) defined to be AQ administrators. </P
></DD
><DT
CLASS="term"
><A
CLASS="indexterm"
NAME="ch05-idx-15868-0"
></A
><A
CLASS="indexterm"
NAME="ch05-idx-15868-1"
></A
><A
CLASS="indexterm"
NAME="ch05-idx-15868-2"
></A
>AQ_USER_ROLE</DT
><DD
CLASS="listitem"
><P
CLASS="para"
>This role grants EXECUTE privileges for all programs in DBMS_AQ. The AQ administrator (an account to which the AQ_ADMINISTRATOR_ROLE privilege has been previously granted) must grant this role to the account(s) defined to be AQ users. </P
></DD
></DL
><BLOCKQUOTE
CLASS="note"
><P
CLASS="para"
><STRONG
>NOTE:</STRONG
> Administrator and user privileges are granted at the database level, and not on specific objects or within schemas. As a result, any Oracle account with the AQ_USER_ROLE can perform enqueue and dequeue operations on <EM
CLASS="emphasis"
>any</EM
> queue in the database instance. Given this situation, how can you minimize the chance of messages being incorrectly queued or dequeued? You are always best off building a package around your AQ usage that hides the names of your queue tables and queues. See the <A
CLASS="xref"
HREF="ch05_07.htm#ch05-SECT-7.5.1"
>Section 5.7, "Oracle AQ Examples"</A
>" section for many illustrations of this technique.</P
></BLOCKQUOTE
><P
CLASS="para"
>Here is an example of the steps you might perform from SQL*Plus to set up an AQ administrator:</P
><BLOCKQUOTE
><PRE
CLASS="programlisting"
>SQL&gt; CONNECT SYS/CHANGE_ON_INSTALL
SQL&gt; GRANT AQ_ADMINISTRATOR_ROLE TO AQADMIN;</PRE
></BLOCKQUOTE
><P
CLASS="para"
>The AQADMIN account can now set up that old standby SCOTT as an AQ user account as follows:</P
><BLOCKQUOTE
><PRE
CLASS="programlisting"
>SQL&gt; CONNECT aqadmin/top_secret
SQL&gt; GRANT AQ_USER_ROLE TO scott;</PRE
></BLOCKQUOTE
><P
CLASS="para"
>If you further wish to create and manipulate queue tables that are enabled for multiple dequeuing (in other words, queues that use subscriber lists to dequeue a message to multiple consumers), you must also execute the <A
CLASS="indexterm"
NAME="ch05-idx-15884-0"
></A
>GRANT_TYPE_ACCESS procedure of the DBMS_AQADM package. The SYS account must do this for the AQ administrator account; that administrator can then do the same for AQ user accounts. Here are the steps:</P
><P
CLASS="para"
>1. Enable AQADMIN for multiple dequeues from SYS:</P
><BLOCKQUOTE
><PRE
CLASS="programlisting"
>SQL&gt; CONNECT SYS/CHANGE_ON_INSTALL
SQL&gt; exec DBMS_AQADM.GRANT_TYPE_ACCESS ('aqadmin');</PRE
></BLOCKQUOTE
><P
CLASS="para"
>2. Enable SCOTT for multiple dequeues from AQADMIN:</P
><BLOCKQUOTE
><PRE
CLASS="programlisting"
>SQL&gt; CONNECT aqadmin/top_secret
SQL&gt; exec DBMS_AQADM.GRANT_TYPE_ACCESS ('scott');</PRE
></BLOCKQUOTE
><P
CLASS="para"
>Now we have two accounts that are ready, willing, and able to do some queuing!<A
CLASS="indexterm"
NAME="ch05-idx-15879-0"
></A
><A
CLASS="indexterm"
NAME="ch05-idx-15879-1"
></A
><A
CLASS="indexterm"
NAME="ch05-idx-15879-2"
></A
><A
CLASS="indexterm"
NAME="ch05-idx-15879-3"
></A
> These steps are also performed for you by the files <EM
CLASS="emphasis"
>aqadmset.sql</EM
><A
CLASS="indexterm"
NAME="ch05-idx-19278-0"
></A
> (for AQ administrators) and <A
CLASS="indexterm"
NAME="ch05-idx-19279-0"
></A
>aqfor.sql (for AQ users). </P
><BLOCKQUOTE
CLASS="tip"
><P
CLASS="para"
><STRONG
>TIP:</STRONG
> If you are running <A
CLASS="indexterm"
NAME="ch05-idx-15885-0"
></A
>Oracle 8.0.3, you might encounter problems with this approach. Under this first production release of Oracle8, you should instead perform all grant operations from the SYS or SYSTEM <A
CLASS="indexterm"
NAME="ch05-idx-18245-0"
></A
>accounts. </P
></BLOCKQUOTE
></DIV
></DIV
><DIV
CLASS="htmlnav"
><P
></P
><HR
ALIGN="LEFT"
WIDTH="515"
TITLE="footer"><TABLE
WIDTH="515"
BORDER="0"
CELLSPACING="0"
CELLPADDING="0"
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="172"
><A
CLASS="sect1"
HREF="ch05_01.htm"
TITLE="5.1 Oracle AQ Concepts"
><IMG
SRC="../gifs/txtpreva.gif"
ALT="Previous: 5.1 Oracle AQ Concepts"
BORDER="0"></A
></TD
><TD
ALIGN="CENTER"
VALIGN="TOP"
WIDTH="171"
><A
CLASS="book"
HREF="index.htm"
TITLE="Oracle Built-in Packages"
><IMG
SRC="../gifs/txthome.gif"
ALT="Oracle Built-in Packages"
BORDER="0"></A
></TD
><TD
ALIGN="RIGHT"
VALIGN="TOP"
WIDTH="172"
><A
CLASS="sect1"
HREF="ch05_03.htm#ch05-SECT-3.1.1"
TITLE="5.3 Oracle AQ Nonprogram Elements"
><IMG
SRC="../gifs/txtnexta.gif"
ALT="Next: 5.3 Oracle AQ Nonprogram Elements"
BORDER="0"></A
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="172"
>5.1 Oracle AQ Concepts</TD
><TD
ALIGN="CENTER"
VALIGN="TOP"
WIDTH="171"
><A
CLASS="index"
HREF="index/idx_0.htm"
TITLE="Book Index"
><IMG
SRC="../gifs/index.gif"
ALT="Book Index"
BORDER="0"></A
></TD
><TD
ALIGN="RIGHT"
VALIGN="TOP"
WIDTH="172"
>5.3 Oracle AQ Nonprogram Elements</TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="515"
TITLE="footer"></DIV
><IMG SRC="../gifs/smnavbar.gif"
USEMAP="#map"
BORDER="0"
ALT="The Oracle Library Navigation">

<P><font size="-1">
<a href="../copyrght.htm#copy">Copyright (c) 2000</a> O'Reilly &amp; Associates. All rights reserved.
</font></P>

<MAP NAME="map">

<AREA SHAPE="RECT"
COORDS="0,0,35,30"
HREF="../index.htm"
ALT="Library Home">

<AREA SHAPE="RECT"
COORDS="40,0,95,30"
HREF="../prog2/index.htm"
ALT="Oracle PL/SQL Programming, 2nd. Ed.">

<AREA SHAPE="RECT"
COORDS="100,0,200,30"
HREF="../guide8i/index.htm"
ALT="Guide to Oracle 8i Features">

<AREA SHAPE="RECT"
COORDS="205,0,245,30"
HREF="index.htm"
ALT="Oracle Built-in Packages">

<AREA SHAPE="RECT"
COORDS="250,0,320,30"
HREF="../advprog/index.htm"
ALT="Advanced PL/SQL Programming with Packages">

<AREA SHAPE="RECT"
COORDS="325,0,420,30"
HREF="../webapp/index.htm"
ALT="Oracle Web Applications">

<AREA SHAPE="RECT"
COORDS="425,0,490,30"
HREF="../langpkt/index.htm"
ALT="Oracle PL/SQL Language Pocket Reference">

<AREA SHAPE="RECT"
COORDS="495,0,570,30"
HREF="../bipkt/index.htm"
ALT="Oracle PL/SQL Built-ins Pocket Reference">
</MAP>

</BODY
>
<!-- Mirrored from liso.cs.pusan.ac.kr by HTTrack Website Copier/3.x [XR&CO'2001] -->
</HTML
>
