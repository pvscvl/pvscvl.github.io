<html><head>
<title>[Chapter 10] Auditing and Logging</TITLE>
<meta name="DC.title" content="Practical UNIX &amp; Internet Security"><meta name="DC.creator" content="Simson Garfinkel &amp; Gene Spafford"><meta name="DC.publisher" content="O'Reilly &amp; Associates, Inc."><meta name="DC.date" content="1999-02-04T00:07:17Z"><meta name="DC.type" content="Text.Monograph"><meta name="DC.format" content="text/html" scheme="MIME"><meta name="DC.source" content="1-56592-148-8" scheme="ISBN"><meta name="DC.language" content="en-US"><meta name="generator" content="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><link rev="made" href="mailto:online-books@oreilly.com" title="Online Books Comments"><link rel="up" href="part03.htm" title="III. System Security"><link rel="prev" href="ch09_03.htm" title="9.3 A Final Note"><link rel="next" href="ch10_02.htm" title="10.2 The acct/pacct Process Accounting File"></HEAD
><body bgcolor="#FFFFFF" text="#000000"><div class="htmlnav"><h1><img src="gifs/smbanner.gif" alt="Practical UNIX &amp; Internet Security" usemap="#srchmap" border="0"></H1
><map naindex.htmlme="srchmap"><area shape="RECT" coords="0,0,466,65" href="index.htm" alt="Practical UNIX &amp; Internet Security"><area shape="RECT" coords="467,0,514,18" href="../search/psrch.htm" alt="Search this book"></MAP
><table width="515" border="0" cellspacing="0" cellpadding="0"><tr><td align="LEFT" valign="TOP" width="172"><a class="SECT1" href="ch09_03.htm" title="9.3 A Final Note"><img src="../gifs/txtpreva.gif" alt="Previous: 9.3 A Final Note" border="0"></A
></TD
><td align="CENTER" valign="TOP" width="171"><b><font face="ARIEL,HELVETICA,HELV,SANSERIF" size="-1">Chapter 10</FONT
></B
></TD
><td align="RIGHT" valign="TOP" width="172"><a class="SECT1" href="ch10_02.htm" title="10.2 The acct/pacct Process Accounting File"><img src="../gifs/txtnexta.gif" alt="Next: 10.2 The acct/pacct Process Accounting File" border="0"></A
></TD
></TR
></TABLE
>&nbsp;<hr align="LEFT" width="515" title="footer"></DIV
><div class="CHAPTER"><h1 class="chapter"><a class="title" name="PUIS-CHP-10">10. Auditing and Logging</A
></H1
><div class="htmltoc"><p><b>Contents:</B
><br><a class="SECT1" href="#PUIS-CHP-10-SECT-1" title="10.1 The Basic Log Files">The Basic Log Files</A
><br><a class="SECT1" href="ch10_02.htm" title="10.2 The acct/pacct Process Accounting File">The acct/pacct Process Accounting File</A
><br><a class="SECT1" href="ch10_03.htm#PUIS-CHP-10-SECT-3.5" title="10.3 Program-Specific Log Files">Program-Specific Log Files</A
><br><a class="SECT1" href="ch10_04.htm#PUIS-CHP-10-SECT-4.1" title="10.4 Per-User Trails in the Filesystem">Per-User Trails in the Filesystem</A
><br><a class="SECT1" href="ch10_05.htm#PUIS-CHP-10-SECT-5.2.1" title="10.5 The UNIX System Log (syslog) Facility">The UNIX System Log (syslog) Facility</A
><br><a class="SECT1" href="ch10_06.htm#PUIS-CHP-10-SECT-6.2" title="10.6 Swatch: A Log File Tool">Swatch: A Log File Tool</A
><br><a class="SECT1" href="ch10_07.htm#PUIS-CHP-10-SECT-7.2.1" title="10.7 Handwritten Logs">Handwritten Logs</A
><br><a class="SECT1" href="ch10_08.htm" title="10.8 Managing Log Files">Managing Log Files</A
></P
><p></P
></DIV
><p class="para"><a class="indexterm" name="AUTOID-12462"></A
><a class="indexterm" name="AUTOID-12464"></A
><a class="indexterm" name="AUTOID-12467"></A
><a class="indexterm" name="AUTOID-12471"></A
><a class="indexterm" name="AUTOID-12475"></A
>After you have
established the protection mechanisms on your system, you will need
to monitor them. You want to be sure that your protection mechanisms
actually work. You will also want to observe any indications of
misbehavior or other problems. This process of monitoring the behavior
of the system is known as <i class="firstterm">auditing</I
>. It is
part of a defense-in-depth strategy: to borrow a phrase from several
years ago, you should trust, but you should also verify.</P
><p class="para"><span class="acronym">UNIX</SPAN
> maintains a number of log files that
keep track of what's been happening to the computer. Early
versions of <span class="acronym">UNIX</SPAN
> used the log files to record
who logged in, who logged out, and what they did. Newer versions
of <span class="acronym">UNIX</SPAN
> provide expanded logging facilities that
record such information as files that are transferred over the network,
attempts by users to become the superuser, electronic mail, and
much more.</P
><p class="para">Log files are an important building block of a secure system:
they form a recorded history, or <em class="emphasis">audit trail</EM
>,
of your computer's past, making it easier for you to track
down intermittent problems or attacks. Using log files, you may
be able to piece together enough information to discover the cause
of a bug, the source of a break-in, and the scope of the damage
involved. In cases where you can't stop damage from occurring,
at least you will have some record of it. Those logs may be exactly
what you need to rebuild your system, conduct an investigation,
give testimony, recover insurance money, or get accurate field service
performed.</P
><p class="para">But beware: Log files also have a fundamental vulnerability.
Because they are often recorded on the system itself, they are subject
to alteration or deletion. As we shall see, there are techniques
that may help you to mitigate this problem, but no technique can
completely remove it unless you log to a different machine.</P
><p class="para">Locating to a different machine is actually a good idea even
if your system supports some other techniques to store the logs.
Consider some method of automatically sending log files to a system
on your network in a physically secured location. For example, sending
logging information to a PC or Apple Macintosh provides a way of
storing the logs in a machine that is considerably more difficult
to break into and disturb. We have heard good reports from people
who are able to use &quot;outmoded&quot; 80486 or 80386
PCs as log machines. For a diagram of such a setup, see <a class="xref" href="#PUIS-CHP-10-FIG-1" title="Secure logging host.">Figure 10.1</A
>.</P
><h4 class="figure"><a class="title" name="PUIS-CHP-10-FIG-1">Figure 10.1: Secure logging host.</A
></H4
><img class="graphic" src="figs/puis_1001.gif" alt="Figure 10.1"><div class="sect1"><h2 class="sect1"><a class="title" name="PUIS-CHP-10-SECT-1">10.1 The Basic Log Files</A
></H2
><p class="para">Most log files are text files that are written line by line
by system programs. For example, each time a user on your system
tries to become the superuser by using the <em class="emphasis">su</EM
>
command, the <em class="emphasis"><a class="indexterm" name="AUTOID-12497"></A
>su</EM
>
program may append a single line to the log file <em class="emphasis">sulog</EM
>,
which records whether the <em class="emphasis">su</EM
> attempt was successful
or not.</P
><p class="para">Different versions of <span class="acronym">UNIX</SPAN
> store log files
in different directories. The most common locations are:</P
><table class="informaltable"><tbody class="tbody"><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1"><p class="para"><i class="filename">/usr/adm</I
></P
></TD
><td class="entry" rowspan="1" colspan="1"><p class="para">Used by early versions of <span class="acronym">UNIX</SPAN
></P
></TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1"><p class="para"><i class="filename">/var/adm</I
></P
></TD
><td class="entry" rowspan="1" colspan="1"><p class="para">Used by newer versions of <span class="acronym">UNIX</SPAN
>,
so that the <em class="emphasis">/usr</EM
> partition can be mounted read-only</P
></TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1"><p class="para"><i class="filename">/var/log</I
></P
></TD
><td class="entry" rowspan="1" colspan="1"><p class="para">Used by some versions of Solaris, Linux,
<span class="acronym">BSD</SPAN
>, and free <span class="acronym">BSD</SPAN
> to store
log files</P
></TD
></TR
></TBODY
></TABLE
><p class="para">Within one of these directories (or a subdirectory in one
of them) you may find variants of some or all of the following files:</P
><table class="informaltable"><tbody class="tbody"><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1"><p class="para"><i class="filename">acct</I
> or <i class="filename">pacct</I
></P
></TD
><td class="entry" rowspan="1" colspan="1"><p class="para">Records commands run by every user</P
></TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1"><p class="para"><i class="filename">aculog</I
></P
></TD
><td class="entry" rowspan="1" colspan="1"><p class="para">Records of dial-out modems (automatic
call units)</P
></TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1"><p class="para"><i class="filename">lastlog</I
></P
></TD
><td class="entry" rowspan="1" colspan="1"><p class="para">Logs each user's most recent
successful login time, and possibly the last unsuccessful login
too</P
></TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1"><p class="para"><i class="filename">loginlog</I
></P
></TD
><td class="entry" rowspan="1" colspan="1"><p class="para">Records bad login attempts</P
></TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1"><p class="para"><i class="filename">messages</I
></P
></TD
><td class="entry" rowspan="1" colspan="1"><p class="para">Records output to the system's
&quot;console&quot; and other messages generated from the
<i class="filename">syslog </I
>facility</P
></TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1"><p class="para"><i class="filename">sulog</I
></P
></TD
><td class="entry" rowspan="1" colspan="1"><p class="para">Logs use of the <em class="emphasis">su</EM
>
command</P
></TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1"><p class="para"><i class="filename">utmp</I
>[1]</P
></TD
><td class="entry" rowspan="1" colspan="1"><p class="para">Records each user currently logged in</P
></TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1"><p class="para"><i class="filename">utmpx</I
></P
></TD
><td class="entry" rowspan="1" colspan="1"><p class="para">Extended <i class="filename">utmp</I
></P
></TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1"><p class="para"><i class="filename">wtmp</I
>[2]</P
></TD
><td class="entry" rowspan="1" colspan="1"><p class="para">Provides a permanent record of each time
a user logged in and logged out. Also records system shutdowns and
startups</P
></TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1"><p class="para"><i class="filename">wtmpx</I
></P
></TD
><td class="entry" rowspan="1" colspan="1"><p class="para">Extended <em class="emphasis">wtmp</EM
></P
></TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1"><p class="para"><i class="filename">vold.log</I
></P
></TD
><td class="entry" rowspan="1" colspan="1"><p class="para">Logs errors encountered with the use
of external media, such as floppy disks or <span class="acronym">CD-ROMS</SPAN
></P
></TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1"><p class="para"><i class="filename">xferlog</I
></P
></TD
><td class="entry" rowspan="1" colspan="1"><p class="para">Logs FTP access</P
></TD
></TR
></TBODY
></TABLE
><blockquote class="footnote"><p class="para">[1] Most versions of
UNIX store the <i class="filename">utmp</I
> file in the <i class="filename">/etc</I
>
directory<i class="filename">.</I
></P
><p class="para">[2] Early versions of
System V UNIX stored the w<i class="filename">tmp</I
> file in the <i class="filename">/etc</I
>directory</P
></BLOCKQUOTE
><p class="para">The following sections describe some of these files and how
to use the <span class="acronym">UNIX</SPAN
> <em class="emphasis">syslog</EM
> facility.</P
><div class="sidebar"><h4 class="sidebar"><a class="title" name="AUTOID-12624">C2 Audit</A
></H4
><p class="para">Many <span class="acronym">UNIX</SPAN
> systems allow the administrator
to enable a comprehensive type of auditing (logging) known as &quot;<a class="indexterm" name="AUTOID-12628"></A
><a class="indexterm" name="AUTOID-12630"></A
><a class="indexterm" name="AUTOID-12633"></A
>
C2 audit.&quot;
This is so-named because it is logging of the form specified by
U.S. Department of Defense regulations to meet the certification
at the C2 level of trust. These regulations are specified in a document
called the <em class="emphasis">Trusted Computer System Evaluation Criteria</EM
>
(often referred to as the &quot;Orange Book&quot; in the
&quot;Rainbow Series&quot;).</P
><p class="para">C2 auditing generally means assigning an <i class="firstterm"><a class="indexterm" name="AUTOID-12639"></A
>audit ID</I
> to each group of related processes,
starting at login. Thereafter, certain forms of system calls performed
by every process are logged with the audit ID. This includes calls
to open and close files, change directory, alter user process parameters,
and so on.</P
><p class="para">Despite the mandate for the general content of such logging,
there is no generally accepted standard for the format. Thus, each
vendor that provides C2-style logging seems to have a different
format, different controls, and different locations for the logs.
If you feel the need to set such logging on your machine, we recommend
that you read the documentation carefully. Furthermore, we recommend
that you be careful about what you log so as not to generate lots
of extraneous information, and that you log to a disk partition
with lots of space.</P
><p class="para">The last suggestion, above, reflects one of the biggest problems
with C2 audit: it can consume a huge amount of space on an active
system in a short amount of time. The other main problem with C2
audit is that it is useless without some interpretation and reduction
tools, and these are not generally available from vendors&nbsp;- the
DoD regulations only require that the logging be done, not that
it be usable! Vendors have generally provided only as much as is
required to meet the regulations and no more.</P
><p class="para">Only a few third-party companies provide intrusion detection
or audit-analysis tools: <em class="emphasis">Stalker, </EM
>from Haystack
Laboratories, is one such product with some sophisticated features.
Development of more sophisticated tools is an ongoing, current area
of research for many people. We hope to be able to report something
more positive in a third edition of this book.</P
><p class="para">In the meantime, if you are not using one of these products,
and you aren't at a DoD site that requires C2 logging,
you may not want to enable C2 logging (unless you like filling up
your disks with data you may not be able to interpret). On the other
hand, if you have a problem, the more logging you have, the more
likely you will be able to determine what happened. Therefore, review
the documentation for the audit tools provided with your system
if it claims C2 audit capabilities, and experiment with them to
determine if you want to enable the data collection.</P
></DIV
><div class="sect2"><h3 class="sect2"><a class="title" name="PUIS-CHP-10-SECT-1.1">10.1.1 lastlog File</A
></H3
><p class="para"><span class="acronym">UNIX</SPAN
><a class="indexterm" name="AUTOID-12650"></A
><a class="indexterm" name="AUTOID-12652"></A
><a class="indexterm" name="AUTOID-12655"></A
><a class="indexterm" name="AUTOID-12658"></A
><a class="indexterm" name="AUTOID-12661"></A
><a class="indexterm" name="AUTOID-12664"></A
>
records the last time that each user logged into the system in the
<em class="emphasis">lastlog</EM
> log file. <a class="indexterm" name="AUTOID-12668"></A
><a class="indexterm" name="AUTOID-12670"></A
>
This time is
displayed each time you log in:</P
><blockquote class="screen"><pre class="screen">login: ti
password: <i class="systemitem.password">books2sell</I
>
Last login: Tue Jul 12 07:49:59 on tty01 </PRE
></BLOCKQUOTE
><p class="para"></P
><p class="para">This time is also reported when the <em class="emphasis"><a class="indexterm" name="AUTOID-12678"></A
>finger</EM
> command is used:</P
><blockquote class="screen"><pre class="screen">% finger tim
Login name: tim           In real life: Tim Hack
Directory: /Users/tim     Shell: /bin/csh
Last login Tue Jul 12 07:49:59 on tty01
No unread mail
No Plan.
% </PRE
></BLOCKQUOTE
><p class="para">Some versions of <a class="indexterm" name="AUTOID-12682"></A
>
System
V <span class="acronym">UNIX</SPAN
> display both the last successful login
and the last unsuccessful login when a user logs into the system:</P
><blockquote class="screen"><pre class="screen">login: tim
password: <i class="systemitem.password">books2sell</I
>
Last successful login for tim : Tue Jul 12 07:49:59 on tty01
Last unsuccessful login for tim : Tue Jul 06 09:22:10 on tty01</PRE
></BLOCKQUOTE
><p class="para">Teach your users to check the last login time each time they
log in. If the displayed time doesn't correspond to the
last time they used the system, somebody else might have been using
their account. If this happens, the user should immediately change
the account's password and notify the system administrator.</P
><p class="para">Unfortunately, the design of the <em class="emphasis">lastlog</EM
>
mechanism is such that the previous contents of the file are overwritten
at each login. As a result, if a user is inattentive for even a
moment, or if the login message clears the screen, the user may
not notice a suspicious time. Furthermore, even if a suspicious
time is noted, it is no longer available for the system administrator
to examine.</P
><p class="para">One way to compensate for this design flaw is to have a <em class="emphasis"><a class="indexterm" name="AUTOID-12693"></A
>
cron</EM
>-spawned
task periodically make an on-disk copy of the file that can be examined
at a later time. For instance, you could have a shell file run every
six hours to do the following:</P
><blockquote class="screen"><pre class="screen">mv /var/adm/lastlog.3 /var/adm/lastlog.4
mv /var/adm/lastlog.2 /var/adm/lastlog.3
mv /var/adm/lastlog.1 /var/adm/lastlog.2
cp /var/adm/lastlog /var/adm/lastlog.1</PRE
></BLOCKQUOTE
><p class="para">This will preserve the contents of the file in six-hour periods.
If backups are done every day, then they will also be preserved
to the backups for examination later.</P
><p class="para">If you have saved copies of the <i class="systemitem">lastlog</I
>
file, you will need a way to read the contents. Unfortunately, there
is no utility under standard versions of <span class="acronym">UNIX</SPAN
>
that allows you to read one of these files and print all the information.
Therefore, you need to write your own. The following <a class="indexterm" name="AUTOID-12701"></A
>
Perl
script will work on SunOS systems, and you can modify it to work
on others.[3]</P
><blockquote class="footnote"><p class="para">[3] The layout of the <i class="filename">lastlog</I
> file
is usually documented in an include file such as <i class="filename">/usr/include/lastlog.h</I
></P
></BLOCKQUOTE
><div class="example"><h4 class="example"><a class="title" name="PUIS-CHP-10-EX-1">Example 10.1: Script that Reads lastlog File.</A
></H4
><pre class="programlisting">#!/usr/local/bin/perl
$fname = (shift || &quot;/var/adm/lastlog&quot;);
$halfyear = 60*60*24*365.2425/2; # pedantry abounds
setpwent;
while (($name, $junk, $uid) = getpwent) {
		$names{$uid} = $name;
}
endpwent;

open(LASTL, $fname);
for (uid = 0; read(LASTL, $record, 28); $uid++) {
	(	$time, $line, $host) = unpack('l A8 A16', $record);
		next unless $time;

		$host = &quot;($host)&quot; if $host;
		($sec, $min, $hour, $mday, $mon, $year) = localtime($time);
    $year += 1900 + ($year &lt; 70 ? 100 : 0);
		print $names{$uid}, $line, &quot;$mday/$mon&quot;;
		print (time - $time &gt; $halfyear) ? &quot;/$year&quot; : &quot;  &quot;$hour:$min&quot;;
		print &quot;   $host\n&quot;;
}
close LASTL;</PRE
></DIV
><p class="para">This program starts by checking for a command-line argument
(the &quot;shift&quot;); if none is present, it uses the
default. It then calculates the number of seconds in half a year,
to be used to determine the format of the output (logins more than
six months in the past are printed differently). Next, it builds
an associative array of <span class="acronym">UIDS</SPAN
> to login names.</P
><p class="para">After this initialization, the program reads a record at a
time from the <em class="emphasis">lastlog</EM
> file. Each binary record
is then unpacked and decoded. The stored time is decoded into something
more understandable, and then the output is printed.</P
><p class="para">While the <em class="emphasis">lastlog</EM
> file is designed to
provide quick access to the last time that a person logged into
the system, it does not provide a detailed history recording the
use of each account. For that, <span class="acronym">UNIX</SPAN
> uses the
<em class="emphasis">wtmp</EM
> log file.<a class="indexterm" name="AUTOID-12719"></A
><a class="indexterm" name="AUTOID-12721"></A
><a class="indexterm" name="AUTOID-12724"></A
><a class="indexterm" name="AUTOID-12727"></A
><a class="indexterm" name="AUTOID-12730"></A
><a class="indexterm" name="AUTOID-12733"></A
></P
></DIV
><div class="sect2"><h3 class="sect2"><a class="title" name="PUIS-CHP-10-SECT-1.2">10.1.2 utmp and wtmp Files</A
></H3
><p class="para"><span class="acronym">UNIX</SPAN
><a class="indexterm" name="AUTOID-12740"></A
><a class="indexterm" name="AUTOID-12743"></A
><a class="indexterm" name="AUTOID-12745"></A
><a class="indexterm" name="AUTOID-12748"></A
><a class="indexterm" name="AUTOID-12750"></A
><a class="indexterm" name="AUTOID-12752"></A
><a class="indexterm" name="AUTOID-12755"></A
><a class="indexterm" name="AUTOID-12758"></A
>
keeps track of who is currently logged
into the system with a special file called <em class="emphasis">/etc/utmp</EM
>.
This is a binary file that contains a record for every active <em class="emphasis">tty</EM
>
line, and generally does not grow to be more than a few kilobytes
in length (at the most). A second file, <em class="emphasis">/var/adm/wtmp</EM
>,
keeps track of both logins and logouts. This file grows every time
a user logs in or logs out, and can grow to be many megabytes in
length unless it is pruned.</P
><p class="para"><a class="indexterm" name="AUTOID-12765"></A
>In Berkeley-derived
versions of <span class="acronym">UNIX</SPAN
>, the entries in the <em class="emphasis">utmp</EM
>
and <em class="emphasis">wtmp</EM
> files contain:</P
><ul class="itemizedlist"><li class="listitem"><p class="para">Name of the terminal device used for
login</P
></LI
><li class="listitem"><p class="para">Username</P
></LI
><li class="listitem"><p class="para">Hostname that the connection originated from, if
the login was made over a network</P
></LI
><li class="listitem"><p class="para">Time that the user logged on</P
></LI
></UL
><p class="para">In <a class="indexterm" name="AUTOID-12781"></A
>
System
V <span class="acronym">UNIX</SPAN
>, the <i class="systemitem">wtmp</I
>
file is placed in <em class="emphasis">/etc/wtmp</EM
> and is also used
for accounting. The AT&amp;T System V.3.2 <em class="emphasis">utmp</EM
>
and <em class="emphasis">wtmp</EM
> entries contain:</P
><ul class="itemizedlist"><li class="listitem"><p class="para">Username</P
></LI
><li class="listitem"><p class="para">Terminal line number</P
></LI
><li class="listitem"><p class="para">Device name</P
></LI
><li class="listitem"><p class="para">Process ID of the login shell</P
></LI
><li class="listitem"><p class="para">Code that denotes the type of entry</P
></LI
><li class="listitem"><p class="para">Exit status of the process</P
></LI
><li class="listitem"><p class="para">Time that the entry was made</P
></LI
></UL
><p class="para">The extended <em class="emphasis"><a class="indexterm" name="AUTOID-12806"></A
><a class="indexterm" name="AUTOID-12808"></A
><a class="indexterm" name="AUTOID-12811"></A
><a class="indexterm" name="AUTOID-12813"></A
>wtmpx</EM
>
file used by Solaris, <span class="acronym">IRIX</SPAN
> and other <span class="acronym">SVR4</SPAN
>
<span class="acronym">UNIX</SPAN
> operating systems, includes the following:</P
><ul class="itemizedlist"><li class="listitem"><p class="para">Username (32 characters instead of
8)</P
></LI
><li class="listitem"><p class="para"><em class="emphasis">inittab</EM
> id (indicates the type
of connection; see <a class="xref" href="appc_01.htm" title="UNIX Processes">Appendix C, <cite class="appendix">UNIX Processes</CITE
></A
>)</P
></LI
><li class="listitem"><p class="para">Terminal name (32 characters instead of 12)</P
></LI
><li class="listitem"><p class="para">Device name</P
></LI
><li class="listitem"><p class="para">Process ID of the login shell</P
></LI
><li class="listitem"><p class="para">Code that denotes the type of entry</P
></LI
><li class="listitem"><p class="para">Exit status of the process</P
></LI
><li class="listitem"><p class="para">Time that the entry was made</P
></LI
><li class="listitem"><p class="para">Session ID</P
></LI
><li class="listitem"><p class="para">Unused bytes for future expansions</P
></LI
><li class="listitem"><p class="para">Remote host name (for logins that originated over
a network)</P
></LI
></UL
><p class="para"><span class="acronym">UNIX</SPAN
> programs that report the users that
are currently logged into the system (<em class="emphasis">who, whodo, w, 
<a class="indexterm" name="AUTOID-12847"></A
><a class="indexterm" name="AUTOID-12849"></A
><a class="indexterm" name="AUTOID-12851"></A
><a class="indexterm" name="AUTOID-12853"></A
><a class="indexterm" name="AUTOID-12855"></A
>
users, </EM
>and <em class="emphasis">finger</EM
>),
do so by scanning the <em class="emphasis">/etc/utmp</EM
> file. The <i class="systemitem">write</I
> command checks this file
to see if a user is currently logged in, and determines which terminal
he is.</P
><p class="para">The <em class="emphasis"><a class="indexterm" name="AUTOID-12862"></A
>last</EM
>
program, which prints a detailed report of the times of the most
recent user logins, does so by scanning the <em class="emphasis">wtmp</EM
>
file.</P
><p class="para">The <em class="emphasis"><a class="indexterm" name="AUTOID-12867"></A
>ps</EM
>
command gives you a more accurate account of who is currently using
your system than the <em class="emphasis">who</EM
>, <em class="emphasis">whodo</EM
>,
<em class="emphasis">users</EM
>, and <em class="emphasis">finger</EM
> commands
because under some circumstances, users can have processes running
without having their usernames appear in the <em class="emphasis">/etc/utmp</EM
>
or <em class="emphasis">/var/adm/wtmp</EM
> files. (For example, a user
may have left a program running and then logged out, or used the
<em class="emphasis">rsh</EM
> command instead of <em class="emphasis">rlogin</EM
>.)</P
><p class="para">However, the commands <em class="emphasis">who</EM
>, <em class="emphasis">users</EM
>,
and <em class="emphasis">finger</EM
> have several advantages over <em class="emphasis">ps</EM
>:</P
><ul class="itemizedlist"><li class="listitem"><p class="para">They often present their information
in a format that is easier to read than the <em class="emphasis">ps</EM
>
output.</P
></LI
><li class="listitem"><p class="para">They sometimes contain information not present in
the <em class="emphasis">ps</EM
> output, such as the names of remote
host origins.</P
></LI
><li class="listitem"><p class="para">They may run significantly faster than <em class="emphasis">ps</EM
>.</P
></LI
></UL
><blockquote class="note"><p class="para"><strong>NOTE:</STRONG
> The <a class="indexterm" name="AUTOID-12894"></A
><a class="indexterm" name="AUTOID-12897"></A
>
permissions on the <i class="filename">/etc/utmp</I
>
file are sometimes set to be writable by any user on many systems.
This is ostensibly to allow various user programs that create windows
or virtual terminals to show the user as &quot;logged&quot;
into each window without requiring superuser privileges. Unfortunately,
if this file is world-writable, then any user can edit her entry
to show a different username or terminal in a <em class="emphasis">who</EM
>
listing&nbsp;- or to show none at all. (She can also edit anybody
else's entry to show whatever she wants!) It also is the
source of an old security hole that keeps reappearing in various
vendors' releases of <span class="acronym">UNIX</SPAN
>: by changing
the terminal name in this file to that of a sensitive file, an attacker
can get system programs that write to user terminals (such as <em class="emphasis">wall</EM
>
and <em class="emphasis">biff</EM
>) to overwrite the target with selected
output. This can lead to compromise or damage.</P
><p class="para">If your system has a mode <em class="emphasis">-rw-rw-rw-</EM
>
<i class="filename">/etc/utmp</I
> file, we recommend that you change
it to remove the write access for nonowners. Then complain to your
vendor for not fixing such an old and well-known flaw.</P
></BLOCKQUOTE
><div class="sect3"><h4 class="sect3"><a class="title" name="PUIS-CHP-10-SECT-1.2.1">10.1.2.1 <a class="indexterm" name="AUTOID-12909"></A
>su
command and /etc/utmp and /var/adm/wtmp
files</A
></H4
><p class="para">When you use the <em class="emphasis">su</EM
> command (see &quot;su:
Changing Who You Claim to Be&quot; in <a class="xref" href="ch04_01.htm" title="Users, Groups, and the Superuser">Chapter 4, <cite class="chapter">Users, Groups, and the Superuser</CITE
></A
>), it
creates a new process with both the process's <i class="firstterm">real
UID </I
>and <i class="firstterm"><a class="indexterm" name="AUTOID-12917"></A
><a class="indexterm" name="AUTOID-12919"></A
>effective UID </I
>altered.
This gives you the ability to access another user's files,
and run programs as the other user.</P
><p class="para">However, while <em class="emphasis">su</EM
> does not change your
entry in the <i class="filename">/etc/utmp</I
> or the <i class="filename">/var/adm/wtmp</I
>files, the <em class="emphasis">finger</EM
> command will continue
to display the account to which you logged in, not the one that
you <em class="emphasis">su</EM
>'ed to. Many other programs
as well &nbsp;- such as <em class="emphasis">mail</EM
>&nbsp;- may
not work properly when used from within a <em class="emphasis">su</EM
>
subshell, as they determine your username from the <em class="emphasis">/etc/utmp</EM
>
entry and not from the real or effective <span class="acronym">UID</SPAN
>.</P
><p class="para">Note that different versions of the <em class="emphasis">su</EM
>
command have different options available that allow you to reset
your environment, run a different command shell, or otherwise modify
the default behavior. One common argument is a simple dash, as in
&quot;<em class="emphasis">su</EM
> - <i class="filename">user</I
>&quot;.
This form will cause the shell for <i class="filename">user</I
> to
start up as if it were a login shell.</P
><p class="para">Thus, the <em class="emphasis">su</EM
> command should be used with
caution. While it is useful for quick tests, because it does not
properly update the <em class="emphasis">utmp</EM
> and <em class="emphasis">wtmp</EM
>
files, it can cause substantial confusion to other users and to
some system utilities.<a class="indexterm" name="AUTOID-12941"></A
><a class="indexterm" name="AUTOID-12944"></A
><a class="indexterm" name="AUTOID-12946"></A
><a class="indexterm" name="AUTOID-12949"></A
></P
></DIV
></DIV
><div class="sect2"><h3 class="sect2"><a class="title" name="PUIS-CHP-10-SECT-1.3">10.1.3 last Program</A
></H3
><p class="para"><a class="indexterm" name="AUTOID-12955"></A
><a class="indexterm" name="AUTOID-12957"></A
>Every
time a user logs in or logs out, <span class="acronym">UNIX</SPAN
> makes a
record in the file <em class="emphasis">wtmp</EM
>. The <em class="emphasis">last</EM
>
program displays the contents of this file in an understandable
form.[4] If you run <em class="emphasis">last</EM
>
with no arguments, the command displays all logins and logouts on
every device. <em class="emphasis">last</EM
> will display the entire
file; you can abort the display by pressing the interrupt character
(usually <span class="acronym">CTRL-C</SPAN
>):</P
><blockquote class="footnote"><p class="para">[4] On some SVR4 systems you can use the &quot;<em class="emphasis">who
-a</EM
>&quot; command to view the contents of the <em class="emphasis">wtmp</EM
>
file Check your documentation to see which command version you would
use on your system.</P
></BLOCKQUOTE
><blockquote class="screen"><pre class="screen">% last
dpryor    ttyp3    std.com          Sat Mar 11 12:21 - 12:24  (00:02)
simsong   ttyp2    204.17.195.43    Sat Mar 11 11:56 - 11:57  (00:00)
simsong   ttyp1    204.17.195.43    Sat Mar 11 11:37   still logged in
dpryor    console                   Wed Mar  8 10:47 - 17:41 (2+06:53)
devon     console                   Wed Mar  8 10:43 - 10:47  (00:03)
simsong   ttyp3    pleasant.cambrid Mon Mar  6 16:27 - 16:28  (00:01)
dpryor    ftp      mac4             Fri Mar  3 16:31 - 16:33  (00:02)
dpryor    console                   Fri Mar  3 12:01 - 10:43 (4+22:41)
simsong   ftp      pleasant.cambrid Fri Mar  3 08:40 - 08:56  (00:15)
simsong   ttyp2    pleasant.cambrid Thu Mar  2 20:08 - 21:08  (00:59)
...</PRE
></BLOCKQUOTE
><p class="para">In this display, you can see that five login sessions have
been active since March 7th: <em class="emphasis">simsong</EM
>, <em class="emphasis">dpryor</EM
>,
<em class="emphasis">devon</EM
>, <em class="emphasis">dpyror</EM
> (again),
and <em class="emphasis">simsong</EM
> (again). Two of the users (<em class="emphasis">dpryor</EM
>
and <em class="emphasis">devon</EM
>) logged on to the computer console.
The main user of this machine is probably the user <em class="emphasis">dpryor</EM
>
(in fact, this computer is a workstation sitting on <em class="emphasis">dpryor</EM
>'s
desk.) The terminal name <em class="emphasis">ftp</EM
> indicates that
<em class="emphasis">dpryor</EM
> was logged in for <span class="acronym">FTP</SPAN
>
file transfer. Other terminal names may also appear here, depending
on your system type and configuration; for instance, you might have
an entry showing <em class="emphasis">pc-nfs</EM
> as an entry type.</P
><p class="para">The <em class="emphasis">last</EM
> command allows you to specify
a <a class="indexterm" name="AUTOID-12987"></A
>
username or a
terminal as an argument to prune the amount of information displayed.
If you provide a username, <em class="emphasis">last</EM
> displays logins
and logouts only for that user. If you provide a <a class="indexterm" name="AUTOID-12991"></A
>
terminal name, <em class="emphasis">last</EM
>
displays logins and logouts only for the specified terminal:</P
><blockquote class="screen"><pre class="screen">% last dpryor
dpryor    ttyp3    std.com          Sat Mar 11 12:21 - 12:24  (00:02)
dpryor    console                   Wed Mar  8 10:47 - 17:41 (2+06:53)
dpryor    ftp      mac4             Fri Mar  3 16:31 - 16:33  (00:02)
dpryor    console                   Fri Mar  3 12:01 - 10:43 (4+22:41)
dpryor    ftp      mac4             Mon Feb 27 10:43 - 10:45  (00:01)
dpryor    ttyp6    std.com          Sun Feb 26 01:12 - 01:13  (00:01)
dpryor    ftp      mac4             Thu Feb 23 14:42 - 14:43  (00:01)
dpryor    ftp      mac4             Thu Feb 23 14:20 - 14:25  (00:04)
dpryor    ttyp3    mac4             Wed Feb 22 13:04 - 13:06  (00:02)
dpryor    console                   Tue Feb 21 09:57 - 12:01 (10+02:04)</PRE
></BLOCKQUOTE
><p class="para">You may wish to issue the <em class="emphasis">last</EM
> command
every morning to see if there were unexpected logins during the
previous night.</P
><p class="para">On some systems, the <em class="emphasis">wtmp</EM
> file also logs
<a class="indexterm" name="AUTOID-12999"></A
>
shutdowns and reboots.</P
><div class="sect3"><h4 class="sect3"><a class="title" name="PUIS-CHP-10-SECT-1.3.1">10.1.3.1 Pruning the wtmp file</A
></H4
><p class="para">The <em class="emphasis"><a class="indexterm" name="AUTOID-13005"></A
><a class="indexterm" name="AUTOID-13007"></A
><a class="indexterm" name="AUTOID-13009"></A
>wtmp</EM
>
file will continue to grow until you have no space left on your
computer's hard disk. For this reason, many vendors include
shell scripts with their <span class="acronym">UNIX</SPAN
> releases that zero
the <em class="emphasis">wtmp</EM
> file automatically on a regular basis
(such as once a week or once a month). These scripts are run automatically
by the <em class="emphasis">cron</EM
> program.</P
><p class="para">For example, many monthly shell scripts contain a statement
that looks like this:</P
><blockquote class="screen"><pre class="screen"># zero the log file
cat /dev/null &gt;/var/adm/wtmp</PRE
></BLOCKQUOTE
><p class="para">Instead of this simple-minded approach, you may wish to make
a copy of the <em class="emphasis">wtmp</EM
> file first, so you'll
be able to refer to logins in the previous month. To do so, you
must locate the shell script that zeros your log file and add the
following lines:</P
><blockquote class="screen"><pre class="screen"># make a copy of the log file and zero the old one
rm /var/adm/wtmp.old
ln /var/adm/wtmp /var/adm/wtmp.old
cp /dev/null /var/adm/wtmp.nul
mv /var/adm/wtmp.nul /var/adm/wtmp</PRE
></BLOCKQUOTE
><p class="para">Most versions of the <em class="emphasis">last</EM
> command allow
you to specify a file to use other than <em class="emphasis">wtmp</EM
>
by using the <em class="emphasis"><a class="indexterm" name="AUTOID-13024"></A
>-f</EM
>
option. For example:</P
><blockquote class="screen"><pre class="screen">% last -f /var/adm/wtmp.old</PRE
></BLOCKQUOTE
><p class="para">Some versions of the <em class="emphasis">last</EM
> command do
not allow you to specify a different <em class="emphasis">wtmp</EM
> file
to search through. If you need to check this previous copy and you
are using one of these systems, you will need to momentarily place
the copy of the <em class="emphasis">wtmp</EM
> file back into its original
location. For example, you might use the following shell script
to do the trick:</P
><blockquote class="screen"><pre class="screen">#!/bin/sh
mv /var/adm/wtmp /var/adm/wtmp.real
mv /var/adm/wtmp.old /var/adm/wtmp
last $*
mv /var/adm/wtmp /var/adm/wtmp.old
mv /var/adm/wtmp.real /var/adm/wtmp</PRE
></BLOCKQUOTE
><p class="para">This approach is not without its problems, however. Any logins
and logouts will be logged to the <i class="firstterm">wtmp.old</I
>
file while the command is running.<a class="indexterm" name="AUTOID-13035"></A
><a class="indexterm" name="AUTOID-13038"></A
><a class="indexterm" name="AUTOID-13040"></A
><a class="indexterm" name="AUTOID-13043"></A
><a class="indexterm" name="AUTOID-13045"></A
></P
></DIV
></DIV
><div class="sect2"><h3 class="sect2"><a class="title" name="PUIS-CHP-10-SECT-1.4">10.1.4 loginlog File</A
></H3
><p class="para">If you are using a <a class="indexterm" name="AUTOID-13051"></A
><a class="indexterm" name="AUTOID-13054"></A
><a class="indexterm" name="AUTOID-13056"></A
><a class="indexterm" name="AUTOID-13059"></A
>
System V-based <a class="indexterm" name="AUTOID-13062"></A
>
version
of <span class="acronym">UNIX</SPAN
> (including Solaris), you can log <a class="indexterm" name="AUTOID-13066"></A
>
failed login attempts
in a special file called <i class="filename">/var/adm/loginlog</I
>.</P
><p class="para">To log failed login attempts, you must specifically create
this file with the following sequence of commands:</P
><blockquote class="screen"><pre class="screen"># touch /var/adm/loginlog
# chmod 600 /var/adm/loginlog
# chown root /var/adm/loginlog</PRE
></BLOCKQUOTE
><p class="para">After this file is created, <span class="acronym">UNIX</SPAN
> will log
all failed login attempts to your system. A &quot;failed login
attempt&quot; is defined as a login attempt in which a user
tries to log into your system but types a bad password five times
in a row. Normally, System V <span class="acronym">UNIX</SPAN
> hangs up on
the caller (or disconnects the Telnet connection) after the fifth
attempt. If this file exists, <span class="acronym">UNIX</SPAN
> will also
log the fact that five bad attempts occurred.</P
><p class="para">The contents of the file look like this:</P
><blockquote class="screen"><pre class="screen"># cat /var/adm/loginlog
simsong:/dev/pts/8:Mon Nov 27 00:42:14 1995
simsong:/dev/pts/8:Mon Nov 27 00:42:20 1995
simsong:/dev/pts/8:Mon Nov 27 00:42:26 1995
simsong:/dev/pts/8:Mon Nov 27 00:42:39 1995
simsong:/dev/pts/8:Mon Nov 27 00:42:50 1995
#</PRE
></BLOCKQUOTE
></DIV
></DIV
></DIV
><div class="htmlnav"><p></P
><hr align="LEFT" width="515" title="footer"><table width="515" border="0" cellspacing="0" cellpadding="0"><tr><td align="LEFT" valign="TOP" width="172"><a class="SECT1" href="ch09_03.htm" title="9.3 A Final Note"><img src="../gifs/txtpreva.gif" alt="Previous: 9.3 A Final Note" border="0"></A
></TD
><td align="CENTER" valign="TOP" width="171"><a class="book" href="index.htm" title="Practical UNIX &amp; Internet Security"><img src="../gifs/txthome.gif" alt="Practical UNIX &amp; Internet Security" border="0"></A
></TD
><td align="RIGHT" valign="TOP" width="172"><a class="SECT1" href="ch10_02.htm" title="10.2 The acct/pacct Process Accounting File"><img src="../gifs/txtnexta.gif" alt="Next: 10.2 The acct/pacct Process Accounting File" border="0"></A
></TD
></TR
><tr><td align="LEFT" valign="TOP" width="172">9.3 A Final Note</TD
><td align="CENTER" valign="TOP" width="171"><a class="index" href="index/idx_0.htm" title="Book Index"><img src="../gifs/index.gif" alt="Book Index" border="0"></A
></TD
><td align="RIGHT" valign="TOP" width="172">10.2 The acct/pacct Process Accounting File</TD
></TR
></TABLE
><hr align="LEFT" width="515" title="footer"><p class="nav"><font size="-1">[ <a href="../index.htm" title="The Networking CD Bookshelf">Library Home</A
> | <a href="../dnsbind/index.htm" title="DNS &amp; BIND">DNS &amp; BIND</A
> | <a href="../tcpip/index.htm" title="TCP/IP Network Administration">TCP/IP</A
> | <a href="../sendmail/index.htm" title="sendmail">sendmail</A
> | <a href="../smdref/index.htm" title="sendmail Desktop Reference">sendmail Reference</A
> | <a href="../firewall/index.htm" title="Building Internet Firewalls">Firewalls</A
> | <a href="index.htm" title="Practical UNIX &amp; Internet Security">Practical Security</A
> ]</FONT
></P
></DIV
></BODY
></HTML
>
