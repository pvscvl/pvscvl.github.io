<html><head>
<title>[Chapter 7] 7.6 Using SOCKS for Proxying</TITLE>
<meta name="DC.title" content="Building Internet Firewalls"><meta name="DC.creator" content="D. Brent Chapman &amp; Elizabeth D. Zwicky"><meta name="DC.publisher" content="O'Reilly &amp; Associates, Inc."><meta name="DC.date" content="1999-02-04T00:19:05Z"><meta name="DC.type" content="Text.Monograph"><meta name="DC.format" content="text/html" scheme="MIME"><meta name="DC.source" content="1-56592-124-0" scheme="ISBN"><meta name="DC.language" content="en-US"><meta name="generator" content="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><link rev="made" href="mailto:online-books@oreilly.com" title="Online Books Comments"><link rel="up" href="ch07_01.htm" title="7. Proxy Systems"><link rel="prev" href="ch07_05.htm" title="7.5 Proxying Without a Proxy Server"><link rel="next" href="ch07_07.htm#FIRE-07-S2-16" title="7.7 Using the TIS Internet Firewall Toolkit for Proxying"></HEAD
><body bgcolor="#FFFFFF" text="#000000"><div class="htmlnav"><h1><img src="gifs/smbanner.gif" alt="Building Internet Firewalls" usemap="#srchmap" border="0"></H1
><map nameindex.html="srchmap"><area shape="RECT" coords="0,0,466,65" href="index.htm" alt="Building Internet Firewalls"><area shape="RECT" coords="467,0,514,18" href="../search/fsrch.htm" alt="Search this book"></MAP
><table width="515" border="0" cellspacing="0" cellpadding="0"><tr><td align="LEFT" valign="TOP" width="172"><a class="SECT1" href="ch07_05.htm" title="7.5 Proxying Without a Proxy Server"><img src="../gifs/txtpreva.gif" alt="Previous: 7.5 Proxying Without a Proxy Server" border="0"></A
></TD
><td align="CENTER" valign="TOP" width="171"><b><font face="ARIEL,HELVETICA,HELV,SANSERIF" size="-1">Chapter 7<br>Proxy Systems</FONT
></B
></TD
><td align="RIGHT" valign="TOP" width="172"><a class="SECT1" href="ch07_07.htm#FIRE-07-S2-16" title="7.7 Using the TIS Internet Firewall Toolkit for Proxying"><img src="../gifs/txtnexta.gif" alt="Next: 7.7 Using the TIS Internet Firewall Toolkit for Proxying" border="0"></A
></TD
></TR
></TABLE
>&nbsp;<hr align="LEFT" width="515" title="footer"></DIV
><div class="SECT1"><h2 class="sect1"><a class="title" name="FIRE-07-S1-6">7.6 Using <span class="acronym">SOCKS</SPAN
> for
Proxying</A
></H2
><p class="para"><a class="indexterm" name="CH07PSSOCKS"></A
><a class="indexterm" name="CH07SOCKS"></A
>The <span class="acronym">SOCKS</SPAN
> package, originally written by David
Koblas and Michelle Koblas, and currently maintained by Ying-Da Lee,
is an example of the type of proxy system that requires custom
clients. <span class="acronym">SOCKS</SPAN
> is freely available, and it has
become the de facto standard proxying package on the Internet. The
package is on track to become an official Internet standard: a Request
For Comments (<span class="acronym">RFC</SPAN
>) has been written and is
currently undergoing the approval process. <a class="xref" href="appb_01.htm" title="Tools">Appendix B, <cite class="appendix">Tools</CITE
></A
>
tells you how to get <span class="acronym">SOCKS</SPAN
>.</P
><p class="para"><a class="indexterm" name="AUTOID-7460"></A
>In order to make it easy to support new clients,
<span class="acronym">SOCKS</SPAN
> is extremely generic. This is part of what
makes it so popular, but it has the disadvantage that
<span class="acronym">SOCKS</SPAN
> can't provide intelligent logging or access
control. It provides logging, but most of the logging is done on the
client, making it difficult to collect the information in a single
place for examination. <span class="acronym">SOCKS</SPAN
> does log connection
requests on the server; provides access control by source, and
destination host and protocol; and allows configurable responses to
access denials. For example, it can be configured to notify an
administrator of incoming access attempts and to let users know why
their outgoing access attempts were denied.</P
><p class="para"><a class="indexterm" name="AUTOID-7467"></A
>One drawback of <span class="acronym">SOCKS</SPAN
> is that it works only for
<span class="acronym">TCP</SPAN
>-based clients; it doesn't work for
<span class="acronym">UDP</SPAN
>-based clients (like Archie clients, for
example). If you are using a <span class="acronym">UDP</SPAN
>-based client, you
may want to get another package, the <span class="acronym">UDP</SPAN
> Packet
Relayer.  This program serves much the same function for
<span class="acronym">UDP</SPAN
>-based clients as <span class="acronym">SOCKS</SPAN
>
serves for <span class="acronym">TCP</SPAN
>-based clients. Like
<span class="acronym">SOCKS</SPAN
>, the <span class="acronym">UDP</SPAN
> Packet Relayer is freely
available on the Internet.</P
><p class="para">The prime advantage of <span class="acronym">SOCKS</SPAN
> is its
popularity. Because <span class="acronym">SOCKS</SPAN
> is widely used, server
implementations and <span class="acronym">SOCKS</SPAN
>-ified clients (i.e., versions
of programs like <span class="acronym">FTP</SPAN
> and Telnet that have already
been converted to use <span class="acronym">SOCKS</SPAN
>) are commonly
available, and help is easy to find. This can be a double-edged sword;
cases have been reported where intruders to firewalled sites have
installed their own <span class="acronym">SOCKS</SPAN
>-knowledgeable clients.</P
><p class="para">The <span class="acronym">SOCKS</SPAN
> package includes the following
components:</P
><ul class="itemizedlist"><li class="listitem"><p class="para">The <span class="acronym">SOCKS</SPAN
> server. This server must run on a
<span class="acronym">UNIX</SPAN
> system, although it has been ported to many
different variants of <span class="acronym">UNIX</SPAN
>.</P
></LI
><li class="listitem"><p class="para">The <span class="acronym">SOCKS</SPAN
> client library for
<span class="acronym">UNIX</SPAN
> machines.</P
></LI
><li class="listitem"><p class="para"><span class="acronym">SOCKS</SPAN
>-ified versions of several standard
<span class="acronym">UNIX</SPAN
> client programs such as <span class="acronym">FTP</SPAN
>
and Telnet.</P
></LI
></UL
><p class="para">In addition, client libraries for Macintosh and Windows systems are
available as separate packages. </P
><p class="para"><a class="xref" href="#FIRE-07-FIG-3" title="Using SOCKS for proxying">Figure 7.3</A
> shows the use of
<span class="acronym">SOCKS</SPAN
> for proxying.</P
><h4 class="figure"><a class="title" name="FIRE-07-FIG-3">Figure 7.3: Using <span class="acronym">SOCKS</SPAN
> for proxying</A
></H4
><img class="graphic" src="figs/fire0703.gif" alt="Figure 7.3"><p class="para">Many Internet client programs (both commercial and freely available)
already have <span class="acronym">SOCKS</SPAN
> support built in to them as
a compile-time or a run-time option.</P
><p class="para">How do you convert a client program to use <span class="acronym">SOCKS</SPAN
>?
You need to modify the program so it talks to the
<span class="acronym">SOCKS</SPAN
> server, rather than trying to talk to the
real world directly. You do this by recompiling the program with the
<span class="acronym">SOCKS</SPAN
> library.</P
><p class="para">Converting a client program to use <span class="acronym">SOCKS</SPAN
> is usually
pretty easy. The <span class="acronym">SOCKS</SPAN
> package makes certain
assumptions about how client programs work, and most client programs
already follow these assumptions. For a complete summary of these
assumptions, see the file in the <span class="acronym">SOCKS</SPAN
> release
called <em class="emphasis">What_SOCKS_expects</EM
>.</P
><p class="para"><a class="indexterm" name="AUTOID-7524"></A
><a class="indexterm" name="AUTOID-7527"></A
><a class="indexterm" name="AUTOID-7529"></A
>To convert a client program, you must replace all calls to standard
network functions with calls to the <span class="acronym">SOCKS</SPAN
> versions
of those functions. Here are the calls:

<table class="informaltable"><thead class="thead"><tr class="row" valign="TOP"><th class="entry" align="LEFT" rowspan="1" colspan="1">Standard Network Function</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1"><span class="acronym">SOCKS</SPAN
> Version</TH
></TR
></THEAD
><tbody class="tbody"><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">connect()</TD
><td class="entry" rowspan="1" colspan="1">Rconnect()</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">getsockname()</TD
><td class="entry" rowspan="1" colspan="1">Rgetsockname()</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">bind()</TD
><td class="entry" rowspan="1" colspan="1">Rbind()</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">accept()</TD
><td class="entry" rowspan="1" colspan="1">Raccept()</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">listen()</TD
><td class="entry" rowspan="1" colspan="1">Rlisten()</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">select()</TD
><td class="entry" rowspan="1" colspan="1">Rselect()</TD
></TR
></TBODY
></TABLE
>
You can usually do this simply by adding the following to the
&quot;CFLAGS=&quot; line of the program's Makefile.</P
><blockquote class="screen"><pre class="screen">-Dconnect=Rconnect 
     -Dgetsockname=Rgetsockname 
     -Dbind=Rbind 
     -Daccept=Raccept 
     -Dlisten=Rlisten 
     -Dselect=Rselect &#13;</PRE
></BLOCKQUOTE
><p class="para">Then, recompile and link the program with the 
<span class="acronym">SOCKS</SPAN
> client library.</P
><p class="para">The client machine needs to have not only the
<span class="acronym">SOCKS</SPAN
>-modified clients, but also something to tell
it what <span class="acronym">SOCKS</SPAN
> server to contact for what services
(on <span class="acronym">UNIX</SPAN
> machines, the
<em class="emphasis">/etc/socks.conf</EM
> file). In addition, if you want
to control access by user, the client machines must be running
<em class="emphasis">identd</EM
>, which will allow the
<span class="acronym">SOCKS</SPAN
> server to identify what user is controlling
the port that the connection comes from. Because there's no way for
the <span class="acronym">SOCKS</SPAN
> server to verify that the
<em class="emphasis">identd</EM
> server is reliable, <em class="emphasis">identd</EM
> can't be trusted if there is anybody who might
intentionally be circumventing it.<a class="indexterm" name="AUTOID-7574"></A
><a class="indexterm" name="AUTOID-7575"></A
></P
></DIV
><div class="htmlnav"><p></P
><hr align="LEFT" width="515" title="footer"><table width="515" border="0" cellspacing="0" cellpadding="0"><tr><td align="LEFT" valign="TOP" width="172"><a class="SECT1" href="ch07_05.htm" title="7.5 Proxying Without a Proxy Server"><img src="../gifs/txtpreva.gif" alt="Previous: 7.5 Proxying Without a Proxy Server" border="0"></A
></TD
><td align="CENTER" valign="TOP" width="171"><a class="book" href="index.htm" title="Building Internet Firewalls"><img src="../gifs/txthome.gif" alt="Building Internet Firewalls" border="0"></A
></TD
><td align="RIGHT" valign="TOP" width="172"><a class="SECT1" href="ch07_07.htm#FIRE-07-S2-16" title="7.7 Using the TIS Internet Firewall Toolkit for Proxying"><img src="../gifs/txtnexta.gif" alt="Next: 7.7 Using the TIS Internet Firewall Toolkit for Proxying" border="0"></A
></TD
></TR
><tr><td align="LEFT" valign="TOP" width="172">7.5 Proxying Without a Proxy Server</TD
><td align="CENTER" valign="TOP" width="171"><a class="index" href="index/idx_a.htm" title="Book Index"><img src="../gifs/index.gif" alt="Book Index" border="0"></A
></TD
><td align="RIGHT" valign="TOP" width="172">7.7 Using the TIS Internet Firewall Toolkit for Proxying</TD
></TR
></TABLE
><hr align="LEFT" width="515" title="footer"><p class="nav"><font size="-1">[ <a href="../index.htm" title="The Networking CD Bookshelf">Library Home</A
> | <a href="../dnsbind/index.htm" title="DNS &amp; BIND">DNS &amp; BIND</A
> | <a href="../tcpip/index.htm" title="TCP/IP Network Administration">TCP/IP</A
> | <a href="../sendmail/index.htm" title="sendmail">sendmail</A
> | <a href="../smdref/index.htm" title="sendmail Desktop Reference">sendmail Reference</A
> | <a href="index.htm" title="Building Internet Firewalls">Firewalls</A
> | <a href="../puis/index.htm" title="Practical UNIX &amp; Internet Security">Practical Security</A
> ]</FONT
></P
></DIV
></BODY
></HTML
>
