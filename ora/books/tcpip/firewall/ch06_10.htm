<html><head>
<title>[Chapter 6] 6.10 Putting It All Together</TITLE>
<meta name="DC.title" content="Building Internet Firewalls"><meta name="DC.creator" content="D. Brent Chapman &amp; Elizabeth D. Zwicky"><meta name="DC.publisher" content="O'Reilly &amp; Associates, Inc."><meta name="DC.date" content="1999-02-04T00:18:26Z"><meta name="DC.type" content="Text.Monograph"><meta name="DC.format" content="text/html" scheme="MIME"><meta name="DC.source" content="1-56592-124-0" scheme="ISBN"><meta name="DC.language" content="en-US"><meta name="generator" content="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><link rev="made" href="mailto:online-books@oreilly.com" title="Online Books Comments"><link rel="up" href="ch06_01.htm" title="6. Packet Filtering"><link rel="prev" href="ch06_09.htm" title="6.9 Where to Do Packet Filtering"><link rel="next" href="ch07_01.htm" title="7. Proxy Systems"></HEAD
><body bgcolor="#FFFFFF" text="#000000"><div class="htmlnav"><h1><img src="gifs/smbanner.gif" alt="Building Internet Firewalls" usemap="#srchmap" border="0"></H1
><map name=index.html"srchmap"><area shape="RECT" coords="0,0,466,65" href="index.htm" alt="Building Internet Firewalls"><area shape="RECT" coords="467,0,514,18" href="../search/fsrch.htm" alt="Search this book"></MAP
><table width="515" border="0" cellspacing="0" cellpadding="0"><tr><td align="LEFT" valign="TOP" width="172"><a class="SECT1" href="ch06_09.htm" title="6.9 Where to Do Packet Filtering"><img src="../gifs/txtpreva.gif" alt="Previous: 6.9 Where to Do Packet Filtering" border="0"></A
></TD
><td align="CENTER" valign="TOP" width="171"><b><font face="ARIEL,HELVETICA,HELV,SANSERIF" size="-1">Chapter 6<br>Packet Filtering</FONT
></B
></TD
><td align="RIGHT" valign="TOP" width="172"><a class="CHAPTER" href="ch07_01.htm" title="7. Proxy Systems"><img src="../gifs/txtnexta.gif" alt="Next: 7. Proxy Systems" border="0"></A
></TD
></TR
></TABLE
>&nbsp;<hr align="LEFT" width="515" title="footer"></DIV
><div class="SECT1"><h2 class="sect1"><a class="title" name="FIRE-06-S1-10">6.10 Putting It All Together</A
></H2
><p class="para"><a class="indexterm" name="CH06PACKFILTEX"></A
>This section works through a few more examples to show how many of the
concepts we've talked about in this chapter come together in the real
world. For detailed discussions of the packet filtering
characteristics of particular protocols, see <a class="xref" href="ch08_01.htm" title="Configuring Internet Services">Chapter 8</A
>.</P
><p class="para">This section is designed to demonstrate the process of developing a
filter set; filters are elaborated as we go on, rather than being
produced in final form. We aren't attempting to show a complete filter
set for any site. Every site is different, and you can get burned by
packet filtering if you don't understand all the details and
implications of its use in your particular environment. We want people
to carefully consider and understand what they're doing&nbsp;- not blindly
copy something out of a book (even ours!) without a careful
consideration of how relevant and appropriate it is for their own
situation. In any case, a full solution for a site requires
considering packet filtering, proxying, and configuration issues. That
process is illustrated in <a class="xref" href="ch09_01.htm" title="Two Sample Firewalls">Chapter 9, <cite class="chapter">Two Sample Firewalls</CITE
></A
>.</P
><p class="para">Let's start with a simple example: allowing inbound and outbound
<span class="acronym">SMTP</SPAN
> (so that you can send and receive electronic
mail) and nothing else. You might start with the following rule set.</P
><blockquote class="note"><p class="para"><strong>NOTE:</STRONG
> We assume in this example that, for each packet, your filtering system
looks at the rules in order. It starts at the top until it finds a
rule that matches the packet, and then it takes the action specified.</P
></BLOCKQUOTE
><table class="informaltable"><thead class="thead"><tr class="row" valign="TOP"><th class="entry" align="LEFT" rowspan="1" colspan="1"></TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Direc-</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Source</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Dest.</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Pro-</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Dest.</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1"></TH
></TR
><tr class="row" valign="TOP"><th class="entry" align="LEFT" rowspan="1" colspan="1">Rule</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">tion</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Address</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Address</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">tocol</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Port</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Action</TH
></TR
></THEAD
><tbody class="tbody"><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">A</TD
><td class="entry" rowspan="1" colspan="1">In</TD
><td class="entry" rowspan="1" colspan="1">External</TD
><td class="entry" rowspan="1" colspan="1">Internal</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">25</TD
><td class="entry" rowspan="1" colspan="1">Permit</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">B</TD
><td class="entry" rowspan="1" colspan="1">Out</TD
><td class="entry" rowspan="1" colspan="1">Internal</TD
><td class="entry" rowspan="1" colspan="1">External</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">&gt;1023</TD
><td class="entry" rowspan="1" colspan="1">Permit</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">C</TD
><td class="entry" rowspan="1" colspan="1">Out</TD
><td class="entry" rowspan="1" colspan="1">Internal</TD
><td class="entry" rowspan="1" colspan="1">External</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">25</TD
><td class="entry" rowspan="1" colspan="1">Permit</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">D</TD
><td class="entry" rowspan="1" colspan="1">In</TD
><td class="entry" rowspan="1" colspan="1">External</TD
><td class="entry" rowspan="1" colspan="1">Internal</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">&gt;1023</TD
><td class="entry" rowspan="1" colspan="1">Permit</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">E</TD
><td class="entry" rowspan="1" colspan="1">Either</TD
><td class="entry" rowspan="1" colspan="1">Any</TD
><td class="entry" rowspan="1" colspan="1">Any</TD
><td class="entry" rowspan="1" colspan="1">Any</TD
><td class="entry" rowspan="1" colspan="1">Any</TD
><td class="entry" rowspan="1" colspan="1">Deny</TD
></TR
></TBODY
></TABLE
><ul class="itemizedlist"><li class="listitem"><p class="para">Rules A and B allow inbound <span class="acronym">SMTP</SPAN
> connections
(incoming email).</P
></LI
><li class="listitem"><p class="para">Rules C and D allow outbound <span class="acronym">SMTP</SPAN
> connections
(outgoing email).</P
></LI
><li class="listitem"><p class="para">Rule E is the default rule that applies if all else fails.</P
></LI
></UL
><p class="para">Now, let's consider some sample packets to see what happens. Let's say
that your host has <span class="acronym">IP</SPAN
> address 172.16.1.1, and that
someone is trying to send you mail from the remote host with
<span class="acronym">IP</SPAN
> address 192.168.3.4. Further, let's say 
the sender's <span class="acronym">SMTP</SPAN
> client uses port 1234 to talk to
your <span class="acronym">SMTP</SPAN
> server, which is on port
25. (<span class="acronym">SMTP</SPAN
> servers are always assumed to be on port
25; see the discussion of <span class="acronym">SMTP</SPAN
> in <a class="xref" href="ch08_01.htm" title="Configuring Internet Services">Chapter 8</A
>):</P
><table class="informaltable"><thead class="thead"><tr class="row" valign="TOP"><th class="entry" align="LEFT" rowspan="1" colspan="1"></TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Direc-</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Source</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Dest.</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Pro-</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Dest.</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Action</TH
></TR
><tr class="row" valign="TOP"><th class="entry" align="LEFT" rowspan="1" colspan="1">Packet</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">tion</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Address</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Address</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">tocol</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Port</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">(Rule)</TH
></TR
></THEAD
><tbody class="tbody"><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">1</TD
><td class="entry" rowspan="1" colspan="1">In</TD
><td class="entry" rowspan="1" colspan="1">192.168.3.4</TD
><td class="entry" rowspan="1" colspan="1">172.16.1.1</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">25</TD
><td class="entry" rowspan="1" colspan="1">Permit (A)</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">2</TD
><td class="entry" rowspan="1" colspan="1">Out</TD
><td class="entry" rowspan="1" colspan="1">172.16.1.1</TD
><td class="entry" rowspan="1" colspan="1">192.168.3.4</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">1234</TD
><td class="entry" rowspan="1" colspan="1">Permit (B)</TD
></TR
></TBODY
></TABLE
><p class="para"><a class="xref" href="#FIRE-06-FIG-10" title="Packet filtering: inbound SMTP (sample packets 1 and 2)">Figure 6.10</A
> shows this case.</P
><h4 class="figure"><a class="title" name="FIRE-06-FIG-10">Figure 6.10: Packet filtering: inbound <span class="acronym">SMTP</SPAN
> (sample
packets 1 and 2)</A
></H4
><img class="graphic" src="figs/fire0610.gif" alt="Figure 6.10"><p class="para">In this case, the packet filtering rules permit your incoming email:

<ul class="itemizedlist"><li class="listitem"><p class="para">Rule A permits incoming packets from the sender's
<span class="acronym">SMTP</SPAN
> client to your <span class="acronym">SMTP</SPAN
> server
(represented by packet number 1 above). </P
></LI
><li class="listitem"><p class="para">Rule B permits the responses from your server back to the sender's
client (represented by packet number 2 above). </P
></LI
></UL
></P
><p class="para">What about outgoing email from you to them? Let's say that your
<span class="acronym">SMTP</SPAN
> client uses port 1357 to talk to their
<span class="acronym">SMTP</SPAN
> server:</P
><table class="informaltable"><thead class="thead"><tr class="row" valign="TOP"><th class="entry" align="LEFT" rowspan="1" colspan="1"></TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Direc-</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Source</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Dest.</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Pro-</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Dest.</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Action </TH
></TR
><tr class="row" valign="TOP"><th class="entry" align="LEFT" rowspan="1" colspan="1">Packet</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">tion</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Address</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Address</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">tocol</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Port</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">(Rule)</TH
></TR
></THEAD
><tbody class="tbody"><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">3</TD
><td class="entry" rowspan="1" colspan="1">Out</TD
><td class="entry" rowspan="1" colspan="1">172.16.1.1</TD
><td class="entry" rowspan="1" colspan="1">192.168.3.4</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">25</TD
><td class="entry" rowspan="1" colspan="1">Permit (C)</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">4</TD
><td class="entry" rowspan="1" colspan="1">In</TD
><td class="entry" rowspan="1" colspan="1">192.168.3.4</TD
><td class="entry" rowspan="1" colspan="1">172.16.1.1</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">1357</TD
><td class="entry" rowspan="1" colspan="1">Permit (D)</TD
></TR
></TBODY
></TABLE
><p class="para"><a class="xref" href="#FIRE-06-FIG-11" title="Packet filtering: outbound SMTP (sample packets 3 and 4)">Figure 6.11</A
> shows this case.</P
><h4 class="figure"><a class="title" name="FIRE-06-FIG-11">Figure 6.11: Packet filtering: outbound <span class="acronym">SMTP</SPAN
> (sample
packets 3 and 4)</A
></H4
><img class="graphic" src="figs/fire0611.gif" alt="Figure 6.11"><p class="para">Again, in this case, the packet filtering rules permit your outgoing
email:

<ul class="itemizedlist"><li class="listitem"><p class="para">Rule C permits outgoing packets from your <span class="acronym">SMTP</SPAN
>
client to their <span class="acronym">SMTP</SPAN
> server (represented by packet
number 3 above).</P
></LI
><li class="listitem"><p class="para">Rule D permits the responses from their server back to your client
(represented by packet number 4 above).</P
></LI
></UL
></P
><p class="para">Now, let's stir things up. What happens if someone in the outside world
(for example, someone on on host 10.1.2.3) attempts to open a connection
from port 5150 on his end to the X11 server on port 6000 on one of
your internal systems (for example, 172.16.3.4) in order to carry out an
attack? (See <a class="xref" href="ch08_01.htm" title="Configuring Internet Services">Chapter 8</A
> for a discussion
of X11 and some of its vulnerabilities.)</P
><table class="informaltable"><thead class="thead"><tr class="row" valign="TOP"><th class="entry" align="LEFT" rowspan="1" colspan="1"></TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Direc-</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Source</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Dest.</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Pro-</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Dest.</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Action</TH
></TR
><tr class="row" valign="TOP"><th class="entry" align="LEFT" rowspan="1" colspan="1">Packet</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">tion</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Address</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Address</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">-tocol</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Port</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">(Rule)</TH
></TR
></THEAD
><tbody class="tbody"><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">5</TD
><td class="entry" rowspan="1" colspan="1">In</TD
><td class="entry" rowspan="1" colspan="1">10.1.2.3</TD
><td class="entry" rowspan="1" colspan="1">172.16.3.4</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">6000</TD
><td class="entry" rowspan="1" colspan="1"><b class="emphasis.bold">Permit (D)</B
></TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">6</TD
><td class="entry" rowspan="1" colspan="1">Out</TD
><td class="entry" rowspan="1" colspan="1">172.16.3.4</TD
><td class="entry" rowspan="1" colspan="1">10.1.2.3</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">5150</TD
><td class="entry" rowspan="1" colspan="1"><b class="emphasis.bold">Permit (B)</B
></TD
></TR
></TBODY
></TABLE
><p class="para"><a class="xref" href="#FIRE-06-FIG-12" title="Packet filtering: inbound SMTP (sample packets 5 and 6)">Figure 6.12</A
> shows this case.</P
><h4 class="figure"><a class="title" name="FIRE-06-FIG-12">Figure 6.12: Packet filtering: inbound <span class="acronym">SMTP</SPAN
> (sample
packets 5 and 6)</A
></H4
><img class="graphic" src="figs/fire0612.gif" alt="Figure 6.12"><p class="para">The rule set shown above allows this connection to
take place! In fact, the rule set shown above allows
any connection to take place as long as both ends
of the connection are using ports above 1023. Why?

<ul class="itemizedlist"><li class="listitem"><p class="para">Rules A and B together do what you want to allow
inbound <span class="acronym">SMTP</SPAN
> connections.</P
></LI
><li class="listitem"><p class="para">Rules C and D together do what you want to allow
outbound <span class="acronym">SMTP</SPAN
> connections.</P
></LI
><li class="listitem"><p class="para">But Rules B and D together end up allowing
<em class="emphasis">all</EM
> connections where both ends are using ports
above 1023, and this is certainly not what you intended. </P
></LI
></UL
></P
><p class="para">There are probably lots of vulnerable servers listening on ports above
1023 at your site. Examples are X11 (port 6000), OpenWindows (port
2000), databases (Sybase, Oracle, Informix, and other databases
commonly use site-chosen ports above 1023), and so on. This is why you
need to consider a rule set as a whole, instead of assuming that if
each rule or group of rules is <span class="acronym">OK</SPAN
>, the whole set is
also <span class="acronym">OK</SPAN
>.</P
><p class="para">What can you do about this? Well, what if you also looked at the source
port in making your filtering decisions? Here are those same five basic
rules with the source port added as a criterion:</P
><table class="informaltable"><thead class="thead"><tr class="row" valign="TOP"><th class="entry" align="LEFT" rowspan="1" colspan="1"></TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Direc-</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Source</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Dest.</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Pro-</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Source</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Dest.</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1"></TH
></TR
><tr class="row" valign="TOP"><th class="entry" align="LEFT" rowspan="1" colspan="1">Rule</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">tion</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Address</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Address</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">tocol</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Port</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Port</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Action</TH
></TR
></THEAD
><tbody class="tbody"><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">A</TD
><td class="entry" rowspan="1" colspan="1">In</TD
><td class="entry" rowspan="1" colspan="1">External</TD
><td class="entry" rowspan="1" colspan="1">Internal</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">&gt;1023</TD
><td class="entry" rowspan="1" colspan="1">25</TD
><td class="entry" rowspan="1" colspan="1">Permit</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">B</TD
><td class="entry" rowspan="1" colspan="1">Out</TD
><td class="entry" rowspan="1" colspan="1">Internal</TD
><td class="entry" rowspan="1" colspan="1">External</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">25</TD
><td class="entry" rowspan="1" colspan="1">&gt;1023</TD
><td class="entry" rowspan="1" colspan="1">Permit</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">C</TD
><td class="entry" rowspan="1" colspan="1">Out</TD
><td class="entry" rowspan="1" colspan="1">Internal</TD
><td class="entry" rowspan="1" colspan="1">External</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">&gt;1023</TD
><td class="entry" rowspan="1" colspan="1">25</TD
><td class="entry" rowspan="1" colspan="1">Permit</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">D</TD
><td class="entry" rowspan="1" colspan="1">In</TD
><td class="entry" rowspan="1" colspan="1">External</TD
><td class="entry" rowspan="1" colspan="1">Internal</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">25</TD
><td class="entry" rowspan="1" colspan="1">&gt;1023</TD
><td class="entry" rowspan="1" colspan="1">Permit</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">E</TD
><td class="entry" rowspan="1" colspan="1">Either</TD
><td class="entry" rowspan="1" colspan="1">Any</TD
><td class="entry" rowspan="1" colspan="1">Any</TD
><td class="entry" rowspan="1" colspan="1">Any</TD
><td class="entry" rowspan="1" colspan="1">Any</TD
><td class="entry" rowspan="1" colspan="1">Any</TD
><td class="entry" rowspan="1" colspan="1">Deny</TD
></TR
></TBODY
></TABLE
><p class="para">And here are those same six sample packets, filtered by the new rules:</P
><table class="informaltable"><thead class="thead"><tr class="row" valign="TOP"><th class="entry" align="LEFT" rowspan="1" colspan="1"></TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Direc-</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Source</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Dest.</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Pro-</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Source</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Dest.</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Action</TH
></TR
><tr class="row" valign="TOP"><th class="entry" align="LEFT" rowspan="1" colspan="1">Packet</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">tion</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Address</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Address</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">tocol</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Port</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Port</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">(Rule)</TH
></TR
></THEAD
><tbody class="tbody"><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">1</TD
><td class="entry" rowspan="1" colspan="1">In</TD
><td class="entry" rowspan="1" colspan="1">192.168.3.4</TD
><td class="entry" rowspan="1" colspan="1">172.16.1.1</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">1234</TD
><td class="entry" rowspan="1" colspan="1">25</TD
><td class="entry" rowspan="1" colspan="1">Permit (A)</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">2</TD
><td class="entry" rowspan="1" colspan="1">Out</TD
><td class="entry" rowspan="1" colspan="1">172.16.1.1</TD
><td class="entry" rowspan="1" colspan="1">192.168.3.4</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">25</TD
><td class="entry" rowspan="1" colspan="1">1234</TD
><td class="entry" rowspan="1" colspan="1">Permit (B)</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">3</TD
><td class="entry" rowspan="1" colspan="1">Out</TD
><td class="entry" rowspan="1" colspan="1">172.16.1.1</TD
><td class="entry" rowspan="1" colspan="1">192.168.3.4</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">1357</TD
><td class="entry" rowspan="1" colspan="1">25</TD
><td class="entry" rowspan="1" colspan="1">Permit (C)</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">4</TD
><td class="entry" rowspan="1" colspan="1">In</TD
><td class="entry" rowspan="1" colspan="1">192.168.3.4</TD
><td class="entry" rowspan="1" colspan="1">172.16.1.1</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">25</TD
><td class="entry" rowspan="1" colspan="1">1357</TD
><td class="entry" rowspan="1" colspan="1">Permit (D)</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">5</TD
><td class="entry" rowspan="1" colspan="1">In</TD
><td class="entry" rowspan="1" colspan="1">10.1.2.3</TD
><td class="entry" rowspan="1" colspan="1">172.16.3.4</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">5150</TD
><td class="entry" rowspan="1" colspan="1">6000</TD
><td class="entry" rowspan="1" colspan="1">Deny (E)</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">6</TD
><td class="entry" rowspan="1" colspan="1">Out</TD
><td class="entry" rowspan="1" colspan="1">172.16.3.4</TD
><td class="entry" rowspan="1" colspan="1">10.1.2.3</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">6000</TD
><td class="entry" rowspan="1" colspan="1">5150</TD
><td class="entry" rowspan="1" colspan="1">Deny (E)</TD
></TR
></TBODY
></TABLE
><p class="para">As you can see, when the source port is also considered as a criterion, the
problem packets (numbers 5 and 6, representing an attack on one of your
X11 servers) no longer meet any of the rules for packets to be permitted
(rules A through D). The problem packets end up being denied by the
default rule.</P
><p class="para">OK, now what if you're dealing with a slightly smarter attacker? What
if the attacker uses port 25 as the client port
on his end (he might do this by killing off the
<span class="acronym">SMTP</SPAN
> server on a machine he controls and using its
port, or by carrying out the attack from a machine that never had an
<span class="acronym">SMTP</SPAN
> server in the first place, like a
<span class="acronym">PC</SPAN
>), and then attempts to open a connection to your
X11 server? Here are the packets you'd see:</P
><table class="informaltable"><thead class="thead"><tr class="row" valign="TOP"><th class="entry" align="LEFT" rowspan="1" colspan="1"></TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Direc-</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Source</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Dest.</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Pro-</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Source</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Dest.</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Action</TH
></TR
><tr class="row" valign="TOP"><th class="entry" align="LEFT" rowspan="1" colspan="1">Packet</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">tion</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Address</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Address</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">tocol</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Port</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Port</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">(Rule)</TH
></TR
></THEAD
><tbody class="tbody"><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">7</TD
><td class="entry" rowspan="1" colspan="1">In</TD
><td class="entry" rowspan="1" colspan="1">10.1.2.3</TD
><td class="entry" rowspan="1" colspan="1">172.16.3.4</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">25</TD
><td class="entry" rowspan="1" colspan="1">6000</TD
><td class="entry" rowspan="1" colspan="1"><b class="emphasis.bold">Permit (D)</B
></TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">8</TD
><td class="entry" rowspan="1" colspan="1">Out</TD
><td class="entry" rowspan="1" colspan="1">172.16.3.4</TD
><td class="entry" rowspan="1" colspan="1">10.1.2.3</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">6000</TD
><td class="entry" rowspan="1" colspan="1">25</TD
><td class="entry" rowspan="1" colspan="1"><b class="emphasis.bold">Permit (C)</B
></TD
></TR
></TBODY
></TABLE
><p class="para"><a class="xref" href="#FIRE-06-FIG-13" title="Packet filtering: inbound SMTP (sample packets 7 and 8)">Figure 6.13</A
> shows this case.</P
><h4 class="figure"><a class="title" name="FIRE-06-FIG-13">Figure 6.13: Packet filtering: inbound <span class="acronym">SMTP</SPAN
> (sample
packets 7 and 8)</A
></H4
><img class="graphic" src="figs/fire0613.gif" alt="Figure 6.13"><p class="para">As you can see, the packets would be permitted, and
the attack would likely succeed (X11 security being as weak as it is).</P
><p class="para">So what can you do? The solution is to also consider the
<span class="acronym">ACK</SPAN
> bit as a filtering criterion. Again, here are
those same five rules with the <span class="acronym">ACK</SPAN
> bit also added as
a criterion:</P
><table class="informaltable"><thead class="thead"><tr class="row" valign="TOP"><th class="entry" align="LEFT" rowspan="1" colspan="1"></TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Direc-</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Source</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Dest.</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Pro-</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Source</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Dest.</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">ACK</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1"></TH
></TR
><tr class="row" valign="TOP"><th class="entry" align="LEFT" rowspan="1" colspan="1">Rule</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">tion</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Address</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Address</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">tocol</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Port</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Port</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Set</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Action</TH
></TR
></THEAD
><tbody class="tbody"><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">A</TD
><td class="entry" rowspan="1" colspan="1">In</TD
><td class="entry" rowspan="1" colspan="1">External</TD
><td class="entry" rowspan="1" colspan="1">Internal</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">&gt;1023</TD
><td class="entry" rowspan="1" colspan="1">25</TD
><td class="entry" rowspan="1" colspan="1">Any</TD
><td class="entry" rowspan="1" colspan="1">Permit</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">B</TD
><td class="entry" rowspan="1" colspan="1">Out</TD
><td class="entry" rowspan="1" colspan="1">Internal</TD
><td class="entry" rowspan="1" colspan="1">External</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">25</TD
><td class="entry" rowspan="1" colspan="1">&gt;1023</TD
><td class="entry" rowspan="1" colspan="1">Yes</TD
><td class="entry" rowspan="1" colspan="1">Permit</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">C</TD
><td class="entry" rowspan="1" colspan="1">Out</TD
><td class="entry" rowspan="1" colspan="1">Internal</TD
><td class="entry" rowspan="1" colspan="1">External</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">&gt;1023</TD
><td class="entry" rowspan="1" colspan="1">25</TD
><td class="entry" rowspan="1" colspan="1">Any</TD
><td class="entry" rowspan="1" colspan="1">Permit</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">D</TD
><td class="entry" rowspan="1" colspan="1">In</TD
><td class="entry" rowspan="1" colspan="1">External</TD
><td class="entry" rowspan="1" colspan="1">Internal</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">25</TD
><td class="entry" rowspan="1" colspan="1">&gt;1023</TD
><td class="entry" rowspan="1" colspan="1">Yes</TD
><td class="entry" rowspan="1" colspan="1">Permit</TD
></TR
><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">E</TD
><td class="entry" rowspan="1" colspan="1">Either</TD
><td class="entry" rowspan="1" colspan="1">Any</TD
><td class="entry" rowspan="1" colspan="1">Any</TD
><td class="entry" rowspan="1" colspan="1">Any</TD
><td class="entry" rowspan="1" colspan="1">Any</TD
><td class="entry" rowspan="1" colspan="1">Any</TD
><td class="entry" rowspan="1" colspan="1">Any</TD
><td class="entry" rowspan="1" colspan="1">Deny</TD
></TR
></TBODY
></TABLE
><p class="para">Now, packet 7 (the attacker attempting to open a connection to your X11
client) will fail:</P
><table class="informaltable"><thead class="thead"><tr class="row" valign="TOP"><th class="entry" align="LEFT" rowspan="1" colspan="1"></TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Direc-</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Source</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Dest.</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Pro-</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Source</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Dest.</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">ACK</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Action</TH
></TR
><tr class="row" valign="TOP"><th class="entry" align="LEFT" rowspan="1" colspan="1">Packet</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">tion</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Address</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Address</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">tocol</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Port</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Port</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">Set</TH
><th class="entry" align="LEFT" rowspan="1" colspan="1">(Rule)</TH
></TR
></THEAD
><tbody class="tbody"><tr class="row" valign="TOP"><td class="entry" rowspan="1" colspan="1">7</TD
><td class="entry" rowspan="1" colspan="1">In</TD
><td class="entry" rowspan="1" colspan="1">10.1.2.3</TD
><td class="entry" rowspan="1" colspan="1">172.16.3.4</TD
><td class="entry" rowspan="1" colspan="1"><span class="acronym">TCP</SPAN
></TD
><td class="entry" rowspan="1" colspan="1">25</TD
><td class="entry" rowspan="1" colspan="1">6000</TD
><td class="entry" rowspan="1" colspan="1">No</TD
><td class="entry" rowspan="1" colspan="1">Deny (E)</TD
></TR
></TBODY
></TABLE
><p class="para">The only difference in this rule set are in rules B and D. Of these,
rule D is the most important, because it controls incoming connections
to your site. Rule B applies to connections outgoing from your site,
and sites are generally more interested in controlling incoming
connections than outgoing connections.</P
><p class="para">Rule D now says to accept incoming packets from things that are
supposedly <span class="acronym">SMTP</SPAN
> servers (because the packets are
coming from port 25) only if the packets have the
<span class="acronym">ACK</SPAN
> bit set; that is, only if the packets are part
of a connection started from the inside (from your client to his 
server).</P
><p class="para">If someone attempts to open a <span class="acronym">TCP</SPAN
> connection from
the outside, the very first packet that he sends will
not have the <span class="acronym">ACK</SPAN
> bit set;
that's what's involved in &quot;opening a <span class="acronym">TCP</SPAN
>
connection.&quot; (See the discussion of the <span class="acronym">ACK</SPAN
>
bit in the &quot;<span class="acronym">TCP</SPAN
>&quot; section of
&quot;Protocols above IP&quot; earlier in this chapter.) If you
block that very first packet (packet 7 in the example above), you
block the whole <span class="acronym">TCP</SPAN
> connection. Without certain
information in the headers of the first packet&nbsp;- in particular, the
<span class="acronym">TCP</SPAN
> sequence numbers&nbsp;- the connection can't be
established.</P
><p class="para">Why can't an attacker get around this by simply setting the
<span class="acronym">ACK</SPAN
> bit on the first packet? If he does, the packet
will get past the filters, but the destination will believe the packet
belongs to an existing connection (instead of the one with which the
packet is trying to establish a new connection). When the destination
tries to match the packet up with the supposed existing connection, it
will fail because there isn't one, and the packet will be ignored.</P
><blockquote class="note"><p class="para"><strong>NOTE:</STRONG
> As a basic rule of thumb, any filtering rule that permits incoming
<span class="acronym">TCP</SPAN
> packets for outgoing connections (that is,
connections initiated by internal clients) should require that the
<span class="acronym">ACK</SPAN
> bit be set.</P
><a class="indexterm" name="AUTOID-7066"></A
><a class="indexterm" name="AUTOID-7067"></A
><a class="indexterm" name="AUTOID-7068"></A
><a class="indexterm" name="AUTOID-7069"></A
></BLOCKQUOTE
></DIV
><div class="htmlnav"><p></P
><hr align="LEFT" width="515" title="footer"><table width="515" border="0" cellspacing="0" cellpadding="0"><tr><td align="LEFT" valign="TOP" width="172"><a class="SECT1" href="ch06_09.htm" title="6.9 Where to Do Packet Filtering"><img src="../gifs/txtpreva.gif" alt="Previous: 6.9 Where to Do Packet Filtering" border="0"></A
></TD
><td align="CENTER" valign="TOP" width="171"><a class="book" href="index.htm" title="Building Internet Firewalls"><img src="../gifs/txthome.gif" alt="Building Internet Firewalls" border="0"></A
></TD
><td align="RIGHT" valign="TOP" width="172"><a class="CHAPTER" href="ch07_01.htm" title="7. Proxy Systems"><img src="../gifs/txtnexta.gif" alt="Next: 7. Proxy Systems" border="0"></A
></TD
></TR
><tr><td align="LEFT" valign="TOP" width="172">6.9 Where to Do Packet Filtering</TD
><td align="CENTER" valign="TOP" width="171"><a class="index" href="index/idx_a.htm" title="Book Index"><img src="../gifs/index.gif" alt="Book Index" border="0"></A
></TD
><td align="RIGHT" valign="TOP" width="172">7. Proxy Systems</TD
></TR
></TABLE
><hr align="LEFT" width="515" title="footer"><p class="nav"><font size="-1">[ <a href="../index.htm" title="The Networking CD Bookshelf">Library Home</A
> | <a href="../dnsbind/index.htm" title="DNS &amp; BIND">DNS &amp; BIND</A
> | <a href="../tcpip/index.htm" title="TCP/IP Network Administration">TCP/IP</A
> | <a href="../sendmail/index.htm" title="sendmail">sendmail</A
> | <a href="../smdref/index.htm" title="sendmail Desktop Reference">sendmail Reference</A
> | <a href="index.htm" title="Building Internet Firewalls">Firewalls</A
> | <a href="../puis/index.htm" title="Practical UNIX &amp; Internet Security">Practical Security</A
> ]</FONT
></P
></DIV
></BODY
></HTML
>
