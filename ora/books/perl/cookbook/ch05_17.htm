<html><head>
<title>Recipe 5.16. Program: dutree</TITLE>
<meta name="DC.title" content="Perl Cookbook"><meta name="DC.creator" content="Tom Christiansen &amp; Nathan Torkington"><meta name="DC.publisher" content="O'Reilly &amp; Associates, Inc."><meta name="DC.date" content="1999-07-02T01:32:59Z"><meta name="DC.type" content="Text.Monograph"><meta name="DC.format" content="text/html" scheme="MIME"><meta name="DC.source" content="1-56592-243-3" scheme="ISBN"><meta name="DC.language" content="en-US"><meta name="generator" content="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><link rev="made" href="mailto:online-books@oreilly.com" title="Online Books Comments"><link rel="up" href="ch05_01.htm" title="5. Hashes"><link rel="prev" href="ch05_16.htm" title="5.15. Representing Relationships Between Data"><link rel="next" href="ch06_01.htm" title="6. Pattern Matching"></HEAD
><body bgcolor="#FFFFFF" text="#000000"><div class="htmlnav"><h1><img src="gifs/smbanner.gif" alt="Perl Cookbook" usemap="#srchmap" border="0"></H1
><map name=index.html"srchmap"><area shape="RECT" coords="0,0,466,65" href="index.htm" alt="Perl Cookbook"><area shape="RECT" coords="467,0,514,18" href="../search/csrch.htm" alt="Search this book"></MAP
><table width="515" border="0" cellspacing="0" cellpadding="0"><tr><td align="LEFT" valign="TOP" width="172"><a class="sect1" href="ch05_16.htm" title="5.15. Representing Relationships Between Data"><img src="../gifs/txtpreva.gif" alt="Previous: 5.15. Representing Relationships Between Data" border="0"></A
></TD
><td align="CENTER" valign="TOP" width="171"><b><font face="ARIEL,HELVETICA,HELV,SANSERIF" size="-1"><a class="chapter" rel="up" href="ch05_01.htm" title="5. Hashes">Chapter 5<br>Hashes</A
></FONT
></B
></TD
><td align="RIGHT" valign="TOP" width="172"><a class="chapter" href="ch06_01.htm" title="6. Pattern Matching"><img src="../gifs/txtnexta.gif" alt="Next: 6. Pattern Matching" border="0"></A
></TD
></TR
></TABLE
>&nbsp;<hr align="LEFT" width="515" title="footer"></DIV
><div class="sect1"><h2 class="sect1"><a class="title" name="ch05-chap05_program_0">5.16. Program: dutree</A
></H2
><p class="para">The <em class="emphasis">dutree</EM
><a class="indexterm" name="ch05-idx-1000006537-0"></A
><a class="indexterm" name="ch05-idx-1000006537-1"></A
><a class="indexterm" name="ch05-idx-1000006537-2"></A
><a class="indexterm" name="ch05-idx-1000006537-3"></A
><a class="indexterm" name="ch05-idx-1000006537-4"></A
><a class="indexterm" name="ch05-idx-1000006537-5"></A
> program, shown in <a class="xref" href="#ch05-24951" title="dutree">Example 5.3</A
>, turns the output of <em class="emphasis">du</EM
>.</P
><pre class="programlisting">% du pcb
<code class="userinput"><b><code class="replaceable"><i>19      pcb/fix</I
></CODE
></B
></CODE
>
<code class="userinput"><b><code class="replaceable"><i>20      pcb/rev/maybe/yes</I
></CODE
></B
></CODE
>
<code class="userinput"><b><code class="replaceable"><i>10      pcb/rev/maybe/not</I
></CODE
></B
></CODE
>
<code class="userinput"><b><code class="replaceable"><i>705     pcb/rev/maybe</I
></CODE
></B
></CODE
>
<code class="userinput"><b><code class="replaceable"><i>54      pcb/rev/web</I
></CODE
></B
></CODE
>
<code class="userinput"><b><code class="replaceable"><i>1371    pcb/rev</I
></CODE
></B
></CODE
>
<code class="userinput"><b><code class="replaceable"><i>3       pcb/pending/mine</I
></CODE
></B
></CODE
>
<code class="userinput"><b><code class="replaceable"><i>1016    pcb/pending</I
></CODE
></B
></CODE
>
<code class="userinput"><b><code class="replaceable"><i>2412    pcb</I
></CODE
></B
></CODE
></PRE
><p class="para">into sorted, indented output:</P
><pre class="programlisting"><code class="userinput"><b><code class="replaceable"><i>2412 pcb</I
></CODE
></B
></CODE
>
<code class="userinput"><b><code class="replaceable"><i>   </I
></CODE
></B
></CODE
><code class="literal">|</CODE
><code class="userinput"><b><code class="replaceable"><i>    1371 rev</I
></CODE
></B
></CODE
>
<code class="userinput"><b><code class="replaceable"><i>   </I
></CODE
></B
></CODE
><code class="literal">|       |</CODE
><code class="userinput"><b><code class="replaceable"><i>    705 maybe</I
></CODE
></B
></CODE
>
<code class="userinput"><b><code class="replaceable"><i>   </I
></CODE
></B
></CODE
><code class="literal">|       |      |</CODE
><code class="userinput"><b><code class="replaceable"><i>      675 .</I
></CODE
></B
></CODE
>
<code class="userinput"><b><code class="replaceable"><i>   </I
></CODE
></B
></CODE
><code class="literal">|       |      |</CODE
><code class="userinput"><b><code class="replaceable"><i>       20 yes</I
></CODE
></B
></CODE
>
<code class="userinput"><b><code class="replaceable"><i>   </I
></CODE
></B
></CODE
><code class="literal">|       |      |</CODE
><code class="userinput"><b><code class="replaceable"><i>       10 not</I
></CODE
></B
></CODE
>
<code class="userinput"><b><code class="replaceable"><i>   </I
></CODE
></B
></CODE
><code class="literal">|       |</CODE
><code class="userinput"><b><code class="replaceable"><i>    612 .</I
></CODE
></B
></CODE
>
<code class="userinput"><b><code class="replaceable"><i>   </I
></CODE
></B
></CODE
><code class="literal">|       |</CODE
><code class="userinput"><b><code class="replaceable"><i>     54 web</I
></CODE
></B
></CODE
>
<code class="userinput"><b><code class="replaceable"><i>   </I
></CODE
></B
></CODE
><code class="literal">|</CODE
><code class="userinput"><b><code class="replaceable"><i>    1016 pending</I
></CODE
></B
></CODE
>
<code class="userinput"><b><code class="replaceable"><i>   </I
></CODE
></B
></CODE
><code class="literal">|       |</CODE
><code class="userinput"><b><code class="replaceable"><i>        1013 .</I
></CODE
></B
></CODE
>
<code class="userinput"><b><code class="replaceable"><i>   </I
></CODE
></B
></CODE
><code class="literal">|       |</CODE
><code class="userinput"><b><code class="replaceable"><i>           3 mine</I
></CODE
></B
></CODE
>
<code class="userinput"><b><code class="replaceable"><i>   </I
></CODE
></B
></CODE
><code class="literal">|</CODE
><code class="userinput"><b><code class="replaceable"><i>      19 fix</I
></CODE
></B
></CODE
>
<code class="userinput"><b><code class="replaceable"><i>   </I
></CODE
></B
></CODE
><code class="literal">|</CODE
><code class="userinput"><b><code class="replaceable"><i>       6 .</I
></CODE
></B
></CODE
></PRE
><p class="para">The arguments you give <em class="emphasis">dutree</EM
> are passed through to <em class="emphasis">du</EM
>. That way you could call <em class="emphasis">dutree</EM
> in any of these ways, or maybe more if your <em class="emphasis">du</EM
> supports other options.</P
><pre class="programlisting">% dutree
% dutree /usr
% dutree -a 
% dutree -a /bin</PRE
><p class="para">The <code class="literal">%Dirsize</CODE
> hash maintains the mapping of names to sizes. For example, <code class="literal">$Dirsize{&quot;pcb&quot;}</CODE
> contains 2412 in this sample run. We'll use that hash both for output and for sorting each directory's subdirectories by size.</P
><p class="para"><code class="literal">%Kids</CODE
> is more interesting. For any given path <code class="literal">$path</CODE
>, <code class="literal">$Kids{$path}</CODE
> contains a (reference to an) array of names of subdirectories of this one. The <code class="literal">&quot;pcb&quot;</CODE
> entry contains a reference to an anonymous array containing <code class="literal">&quot;fix&quot;</CODE
>, <code class="literal">&quot;rev&quot;</CODE
>, and <code class="literal">&quot;pending&quot;</CODE
>. The <code class="literal">&quot;rev&quot;</CODE
> entry contains <code class="literal">&quot;maybe&quot;</CODE
> and <code class="literal">&quot;web&quot;</CODE
>. The <code class="literal">&quot;maybe&quot;</CODE
> entry contains <code class="literal">&quot;yes&quot;</CODE
> and <code class="literal">&quot;not&quot;</CODE
>, which do not have their own entries because they are end nodes in the tree.</P
><p class="para">The <code class="literal">output</CODE
><a class="indexterm" name="ch05-idx-1000006538-0"></A
> function is passed the start of the tree &nbsp;-  the last line read in from the output of <em class="emphasis">du</EM
>. First it prints that directory and its size. Then the function sorts the directory's children (if any) so that those with the most disk usage float to the top. Finally, <code class="literal">output</CODE
> calls itself, recursing on each child in order. The extra arguments are used in formatting.</P
><p class="para">This program is inherently recursive because the filesystem is recursive. However, its data structure is not recursive; at least, not the way a circular linked list is. Each value is an array of further keys to process. The recursion resides in the processing, not in the storage.</P
><div class="example"><h4 class="example"><a class="title" name="ch05-24951">Example 5.3: dutree</A
></H4
><pre class="programlisting">#!/usr/bin/perl -w
# dutree - print sorted indented rendition of du output
use strict;

my %Dirsize;
my %Kids;

getdots(my $topdir = input());
output($topdir);

# run du, read in input, save sizes and kids
# return last directory (file?) read
sub input { 
    my($size, $name, $parent);
    @ARGV = (&quot;du @ARGV |&quot;);         # prep the arguments
    while (&lt;&gt;) {                    # magic open is our friend<a class="indexterm" name="ch05-idx-1000006647-0"></A
>
        ($size, $name) = split;
        $Dirsize{$name} = $size;
        ($parent = $name) =~ s#/[^/]+$##;   # dirname
        push @{ $Kids{$parent} }, $name unless eof;
    } 
    return $name;
}

# figure out how much is taken up in each directory
# that isn't stored in subdirectories.  add a new
# fake kid called &quot;.&quot; containing that much.
sub getdots {
    my $root = $_[0];
    my($size, $cursize);
    $size = $cursize = $Dirsize{$root};
    if ($Kids{$root}) {
        for my $kid (@{ $Kids{$root} }) { 
            $cursize -= $Dirsize{$kid};
            getdots($kid);
        }
    } 
    if ($size != $cursize) {
        my $dot = &quot;$root/.&quot;;
        $Dirsize{$dot} = $cursize;
        push @{ $Kids{$root} }, $dot;
    } 
} 

# recursively output everything,
# passing padding and number width in as well
# on recursive calls
sub output {
    my($root, $prefix, $width) = (shift, shift || '', shift || 0);
    my $path;
    ($path = $root) =~ s#.*/##;     # basename
    my $size = $Dirsize{$root};
    my $line = sprintf(&quot;%${width}d %s&quot;, $size, $path);
    print $prefix, $line, &quot;\n&quot;;
    for ($prefix .= $line) {        # build up more output
        s/\d /| /;
        s/[^|]/ /g;
    }
    if ($Kids{$root}) {             # not a bachelor node
        my @Kids = @{ $Kids{$root} };
        @Kids = sort { $Dirsize{$b} &lt;=&gt; $Dirsize{$a} } @Kids;
        $Dirsize{$Kids[0]} =~ /(\d+)/;
        my $width = length $1;
        for my $kid (@Kids) { output($kid, $prefix, $width) }
    }
} </PRE
></DIV
><p class="para">Before Perl supported hashes of arrays directly, Herculean efforts were required to emulate these higher order constructs. Some folks used repeated calls to <code class="literal">split</CODE
> and <code class="literal">join</CODE
>, but these were exceedingly slow.</P
><p class="para"><a class="xref" href="#ch05-29853" title="dutree-orig">Example 5.4</A
> is a version of <em class="emphasis">dutree</EM
> from those days of Perl arcana. Because we didn't have proper array references, we had to usurp the Perl symbol table itself. This program created variables on the fly with bizarre names. Can you find which hash this program is using?</P
><p class="para">The <code class="literal">@{&quot;pcb&quot;}</CODE
> array contains <code class="literal">&quot;pcb/fix&quot;</CODE
>, <code class="literal">&quot;pcb/rev&quot;</CODE
>, and <code class="literal">&quot;pcb/pending&quot;</CODE
>. The <code class="literal">@{&quot;pcb/rev&quot;}</CODE
> array contains <code class="literal">&quot;pcb/rev/maybe&quot;</CODE
> and <code class="literal">&quot;pcb/rev/web&quot;</CODE
>. The <code class="literal">@{&quot;pcb/rev/maybe&quot;}</CODE
> array contains <code class="literal">&quot;pcb/rev/yes&quot;</CODE
> and <code class="literal">&quot;pcb/rev/not&quot;</CODE
>.</P
><p class="para">When you assign something like <code class="literal">&quot;pcb/fix&quot;</CODE
> to <code class="literal">*kid</CODE
>, it promotes the string on the right-hand side to a typeglob. This makes <code class="literal">@kid</CODE
> an alias for <code class="literal">@{&quot;pcb/fix&quot;}</CODE
>&nbsp;- among other things. It would also alias <code class="literal">&amp;kid</CODE
> to <code class="literal">&amp;{&quot;pcb/fix&quot;}</CODE
>, and so on.</P
><p class="para">If that isn't interesting enough, consider how the <code class="literal">local</CODE
> is using dynamic scoping of global variables to avoid passing in extra arguments. Check out what's happening with the <code class="literal">$width</CODE
> variable in the <code class="literal">output</CODE
> routine.</P
><div class="example"><h4 class="example"><a class="title" name="ch05-29853">Example 5.4: dutree-orig</A
></H4
><pre class="programlisting">#!/usr/bin/perl
# <a class="indexterm" name="ch05-idx-1000006913-0"></A
>dutree_orig: the old version pre-perl5 (early 90s)

@lines = `du @ARGV`;
chop(@lines);
&amp;input($top = pop @lines);
&amp;output($top);
exit;

sub input {
    local($root, *kid, $him) = @_[0,0];
    while (@lines &amp;&amp; &amp;childof($root, $lines[$#lines])) {
        &amp;input($him = pop(@lines));
        push(@kid, $him);
    } 
    if (@kid) {
        local($mysize) = ($root =~ /^(\d+)/);
        for (@kid) { $mysize -= (/^(\d+)/)[0]; } 
        push(@kid, &quot;$mysize .&quot;) if $size != $mysize;
    } 
    @kid = &amp;sizesort(*kid);
} 

sub output {
    local($root, *kid, $prefix) = @_[0,0,1];
    local($size, $path) = split(' ', $root);
    $path =~ s!.*/!!;
    $line = sprintf(&quot;%${width}d %s&quot;, $size, $path);
    print $prefix, $line, &quot;\n&quot;;
    $prefix .= $line;
    $prefix =~ s/\d /| /;
    $prefix =~ s/[^|]/ /g;
    local($width) = $kid[0] =~ /(\d+)/ &amp;&amp; length(&quot;$1&quot;);
    for (@kid) { &amp;output($_, $prefix); };
} 

sub sizesort {
    local(*list, @index) = shift;
    sub bynum { $index[$b] &lt;=&gt; $index[$a]; }
    for (@list) { push(@index, /(\d+)/); } 
    @list[sort bynum 0..$#list];
} 

sub childof {
    local(@pair) = @_;
    for (@pair) { s/^\d+\s+//g; s/$/\//; }          
    index($pair[1], $pair[0]) &gt;= 0;
}</PRE
></DIV
><p class="para">The answer to the question posed above, "Which hash is the old <em class="emphasis">dutree</EM
> using?" is <code class="literal">%main::</CODE
>, that is, the Perl symbol table itself. Needless to say, this program will never run under <code class="literal">use</CODE
> <code class="literal">strict</CODE
>. We're happy to report that the updated version runs three times as fast as the old one. That's because the old one keeps looking up variables in the symbol table, and the new one doesn't have to. It's also because we avoid all that slow splitting of the space used and the directory name. But we thought we'd show you the old version because it is instructive<em class="emphasis"></EM
><a class="indexterm" name="ch05-idx-1000007008-0"></A
><a class="indexterm" name="ch05-idx-1000007008-1"></A
><a class="indexterm" name="ch05-idx-1000007008-2"></A
><a class="indexterm" name="ch05-idx-1000007008-3"></A
><a class="indexterm" name="ch05-idx-1000007008-4"></A
><a class="indexterm" name="ch05-idx-1000007008-5"></A
> too. <a class="indexterm" name="ch05-idx-1000007009-0"></A
></P
></DIV
><div class="htmlnav"><p></P
><hr align="LEFT" width="515" title="footer"><table width="515" border="0" cellspacing="0" cellpadding="0"><tr><td align="LEFT" valign="TOP" width="172"><a class="sect1" href="ch05_16.htm" title="5.15. Representing Relationships Between Data"><img src="../gifs/txtpreva.gif" alt="Previous: 5.15. Representing Relationships Between Data" border="0"></A
></TD
><td align="CENTER" valign="TOP" width="171"><a class="book" href="index.htm" title="Perl Cookbook"><img src="../gifs/txthome.gif" alt="Perl Cookbook" border="0"></A
></TD
><td align="RIGHT" valign="TOP" width="172"><a class="chapter" href="ch06_01.htm" title="6. Pattern Matching"><img src="../gifs/txtnexta.gif" alt="Next: 6. Pattern Matching" border="0"></A
></TD
></TR
><tr><td align="LEFT" valign="TOP" width="172">5.15. Representing Relationships Between Data</TD
><td align="CENTER" valign="TOP" width="171"><a class="index" href="index/idx_0.htm" title="Book Index"><img src="../gifs/index.gif" alt="Book Index" border="0"></A
></TD
><td align="RIGHT" valign="TOP" width="172">6. Pattern Matching</TD
></TR
></TABLE
><hr align="LEFT" width="515" title="footer"><p class="nav"><font size="-1">[ <a href="../index.html" title="The Perl CD Bookshelf">Library Home</A
> | <a href="../perlnut/index.htm" title="Perl in a Nutshell">Perl in a Nutshell</A
> | <a href="../learn/index.htm" title="Learning Perl">Learning Perl</A
> | <a href="../learn32/index.htm" title="Learning Perl on Win32 Systems">Learning Perl on Win32</A
> | <a href="../prog/index.htm" title="Programming Perl">Programming Perl</A
> | <a href="../advprog/index.htm" title="Advanced Perl Programming">Advanced Perl Programming</A
> | <a href="index.htm" title="Perl Cookbook">Perl Cookbook</A
> ]</FONT
></P
></DIV
></BODY
></HTML
>
