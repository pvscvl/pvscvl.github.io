<HTML
><HEAD
>
<TITLE>Recipe 7.14. Doing Non-Blocking I/O (Perl Cookbook)</TITLE>
<META
NAME="DC.title"
CONTENT="Perl Cookbook"><META
NAME="DC.creator"
CONTENT="Tom Christiansen &amp; Nathan Torkington"><META
NAME="DC.publisher"
CONTENT="O'Reilly &amp; Associates, Inc."><META
NAME="DC.date"
CONTENT="1999-07-02T01:37:18Z"><META
NAME="DC.type"
CONTENT="Text.Monograph"><META
NAME="DC.format"
CONTENT="text/html"
SCHEME="MIME"><META
NAME="DC.source"
CONTENT="1-56592-243-3"
SCHEME="ISBN"><META
NAME="DC.language"
CONTENT="en-US"><META
NAME="generator"
CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINK
REV="made"
HREF="mailto:online-books@oreilly.com"
TITLE="Online Books Comments"><LINK
REL="up"
HREF="ch07_01.htm"
TITLE="7. File Access"><LINK
REL="prev"
HREF="ch07_14.htm"
TITLE="7.13. Reading from Many Filehandles Without Blocking"><LINK
REL="next"
HREF="ch07_16.htm"
TITLE="7.15. Determining the Number of Bytes to Read"></HEAD
><BODY
BGCOLOR="#FFFFFF"><img alt="Book Home" border="0" src="gifs/smbanner.gif" usemap="#banner-map" /><map name="banner-map"><area shape="rect" coords="1,-2,616,66" href="index.htm" alt="Perl Cookbook"><area shape="rect" coords="629,-11,726,25" href="jobjects/fsearch.htm" alt="Search this book" /></map><div class="navbar"><p>
<TABLE
WIDTH="684"
BORDER="0"
CELLSPACING="0"
CELLPADDING="0"
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="228"
><A
CLASS="sect1"
HREF="ch07_14.htm"
TITLE="7.13. Reading from Many Filehandles Without Blocking"
><IMG
SRC="../gifs/txtpreva.gif"
ALT="Previous: 7.13. Reading from Many Filehandles Without Blocking"
BORDER="0"></A
></TD
><TD
ALIGN="CENTER"
VALIGN="TOP"
WIDTH="228"
><B
><FONT
FACE="ARIEL,HELVETICA,HELV,SANSERIF"
SIZE="-1"
><A
CLASS="chapter"
REL="up"
HREF="ch07_01.htm"
TITLE="7. File Access"
></A
></FONT
></B
></TD
><TD
ALIGN="RIGHT"
VALIGN="TOP"
WIDTH="228"
><A
CLASS="sect1"
HREF="ch07_16.htm"
TITLE="7.15. Determining the Number of Bytes to Read"
><IMG
SRC="../gifs/txtnexta.gif"
ALT="Next: 7.15. Determining the Number of Bytes to Read"
BORDER="0"></A
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="sect1"
><H2
CLASS="sect1"
><A
CLASS="title"
NAME="ch07-17832"
>7.14. Doing Non-Blocking I/O</A
></H2
><DIV
CLASS="sect2"
><H3
CLASS="sect2"
><A
CLASS="title"
NAME="ch07-pgfId-1410"
>Problem<A
CLASS="indexterm"
NAME="ch07-idx-1000009722-0"
></A
><A
CLASS="indexterm"
NAME="ch07-idx-1000009722-1"
></A
><A
CLASS="indexterm"
NAME="ch07-idx-1000009722-2"
></A
><A
CLASS="indexterm"
NAME="ch07-idx-1000009722-3"
></A
></A
></H3
><P
CLASS="para"
>You want to read from or write to a filehandle without the system blocking your process until the program, file, socket, or device at the other end is ready. This is desired less often of regular files than of special files.</P
></DIV
><DIV
CLASS="sect2"
><H3
CLASS="sect2"
><A
CLASS="title"
NAME="ch07-pgfId-1416"
>Solution</A
></H3
><P
CLASS="para"
>Open the file with <CODE
CLASS="literal"
>sysopen,</CODE
> and specify the <CODE
CLASS="literal"
>O_NONBLOCK</CODE
><A
CLASS="indexterm"
NAME="ch07-idx-1000009723-0"
></A
> option:</P
><PRE
CLASS="programlisting"
>use Fcntl;

sysopen(MODEM, &quot;/dev/cua0&quot;, O_NONBLOCK|O_RDWR)
    or die &quot;Can't open modem: $!\n&quot;;</PRE
><P
CLASS="para"
>If you already have a filehandle, use <CODE
CLASS="literal"
>fcntl</CODE
><A
CLASS="indexterm"
NAME="ch07-idx-1000009724-0"
></A
> to change the flags:</P
><PRE
CLASS="programlisting"
>use Fcntl;

$flags = '';
fcntl(HANDLE, F_GETFL, $flags)
    or die &quot;Couldn't get flags for HANDLE : $!\n&quot;;
$flags |= O_NONBLOCK;
fcntl(HANDLE, F_SETFL, $flags)
    or die &quot;Couldn't set flags for HANDLE: $!\n&quot;;</PRE
><P
CLASS="para"
>Once a filehandle is set for non-blocking I/O, the <CODE
CLASS="literal"
>sysread</CODE
> or <CODE
CLASS="literal"
>syswrite</CODE
> calls that would block will instead return <CODE
CLASS="literal"
>undef</CODE
> and set <CODE
CLASS="literal"
>$!</CODE
> to EAGAIN:</P
><PRE
CLASS="programlisting"
>use POSIX qw(:errno_h);

$rv = syswrite(HANDLE, $buffer, length $buffer);
if (!defined($rv) &amp;&amp; $! == EAGAIN) {
    # would block
} elsif ($rv != length $buffer) {
    # incomplete write
} else {
    # successfully wrote
}

$rv = sysread(HANDLE, $buffer, $BUFSIZ);
if (!defined($rv) &amp;&amp; $! == EAGAIN) {
    # would block
} else {
    # successfully read $rv bytes from HANDLE
}</PRE
></DIV
><DIV
CLASS="sect2"
><H3
CLASS="sect2"
><A
CLASS="title"
NAME="ch07-pgfId-1484"
>Discussion</A
></H3
><P
CLASS="para"
>The <CODE
CLASS="literal"
>O_NONBLOCK</CODE
> constant is part of the POSIX standard, so most machines should support it. We use the POSIX module to get the numeric value for the error EAGAIN.</P
></DIV
><DIV
CLASS="sect2"
><H3
CLASS="sect2"
><A
CLASS="title"
NAME="ch07-pgfId-1490"
>See Also</A
></H3
><P
CLASS="para"
>The <CODE
CLASS="literal"
>sysopen</CODE
> and <CODE
CLASS="literal"
>fcntl</CODE
> functions in <I
CLASS="filename"
>perlfunc </I
>(1) and in <A
CLASS="olink"
HREF="../prog/ch03_01.htm"
>Chapter 3</A
> of <A
CLASS="citetitle"
HREF="../prog/index.htm"
TITLE="Programming Perl"
><CITE
CLASS="citetitle"
>Programming Perl</CITE
></A
>; the documentation for the standard POSIX module; your system's <I
CLASS="filename"
>open </I
>(2) and <I
CLASS="filename"
>fcntl</I
> (2) manpages; <A
CLASS="xref"
HREF="ch07_14.htm"
TITLE="Reading from Many Filehandles Without Blocking"
>Recipe 7.13</A
>; <A
CLASS="xref"
HREF="ch07_16.htm"
TITLE="Determining the Number of Bytes to Read"
>Recipe 7.15</A
></P
></DIV
></DIV
><DIV
CLASS="htmlnav"
><P
></P
><HR
ALIGN="LEFT"
WIDTH="684"
TITLE="footer"><TABLE
WIDTH="684"
BORDER="0"
CELLSPACING="0"
CELLPADDING="0"
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="228"
><A
CLASS="sect1"
HREF="ch07_14.htm"
TITLE="7.13. Reading from Many Filehandles Without Blocking"
><IMG
SRC="../gifs/txtpreva.gif"
ALT="Previous: 7.13. Reading from Many Filehandles Without Blocking"
BORDER="0"></A
></TD
><TD
ALIGN="CENTER"
VALIGN="TOP"
WIDTH="228"
><A
CLASS="book"
HREF="index.htm"
TITLE="Perl Cookbook"
><IMG
SRC="../gifs/txthome.gif"
ALT="Perl Cookbook"
BORDER="0"></A
></TD
><TD
ALIGN="RIGHT"
VALIGN="TOP"
WIDTH="228"
><A
CLASS="sect1"
HREF="ch07_16.htm"
TITLE="7.15. Determining the Number of Bytes to Read"
><IMG
SRC="../gifs/txtnexta.gif"
ALT="Next: 7.15. Determining the Number of Bytes to Read"
BORDER="0"></A
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="228"
>7.13. Reading from Many Filehandles Without Blocking</TD
><TD
ALIGN="CENTER"
VALIGN="TOP"
WIDTH="228"
><A
CLASS="index"
HREF="index/index.htm"
TITLE="Book Index"
><IMG
SRC="../gifs/index.gif"
ALT="Book Index"
BORDER="0"></A
></TD
><TD
ALIGN="RIGHT"
VALIGN="TOP"
WIDTH="228"
>7.15. Determining the Number of Bytes to Read</TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="684"
TITLE="footer"><FONT
SIZE="-1"
></DIV<!-- LIBRARY NAV BAR --> <img src="../gifs/smnavbar.gif" usemap="#library-map" border="0" alt="Library Navigation Links"><p> <a href="copyrght.htm">Copyright &copy; 2002</a> O'Reilly &amp; Associates. All rights reserved.</font> </p> <map name="library-map"> <area shape="rect" coords="1,0,85,94" href="../index.htm"><area shape="rect" coords="86,1,178,103" href="../lwp/index.htm"><area shape="rect" coords="180,0,265,103" href="../lperl/index.htm"><area shape="rect" coords="267,0,353,105" href="../perlnut/index.htm"><area shape="rect" coords="354,1,446,115" href="../prog/index.htm"><area shape="rect" coords="448,0,526,132" href="../tk/index.htm"><area shape="rect" coords="528,1,615,119" href="index.htm"><area shape="rect" coords="617,0,690,135" href="../pxml/index.htm"></map> </BODY
></HTML
>
