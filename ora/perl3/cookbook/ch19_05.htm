<HTML
><HEAD
>
<TITLE>Recipe 19.4. Writing a Safe CGI Program (Perl Cookbook)</TITLE>
<META
NAME="DC.title"
CONTENT="Perl Cookbook"><META
NAME="DC.creator"
CONTENT="Tom Christiansen &amp; Nathan Torkington"><META
NAME="DC.publisher"
CONTENT="O'Reilly &amp; Associates, Inc."><META
NAME="DC.date"
CONTENT="1999-07-02T01:45:27Z"><META
NAME="DC.type"
CONTENT="Text.Monograph"><META
NAME="DC.format"
CONTENT="text/html"
SCHEME="MIME"><META
NAME="DC.source"
CONTENT="1-56592-243-3"
SCHEME="ISBN"><META
NAME="DC.language"
CONTENT="en-US"><META
NAME="generator"
CONTENT="Jade 1.1/O'Reilly DocBook 3.0 to HTML 4.0"><LINK
REV="made"
HREF="mailto:online-books@oreilly.com"
TITLE="Online Books Comments"><LINK
REL="up"
HREF="ch19_01.htm"
TITLE="19. CGI Programming"><LINK
REL="prev"
HREF="ch19_04.htm"
TITLE="19.3. Fixing a 500 Server Error"><LINK
REL="next"
HREF="ch19_06.htm"
TITLE="19.5. Making CGI Scripts Efficient"></HEAD
><BODY
BGCOLOR="#FFFFFF"><img alt="Book Home" border="0" src="gifs/smbanner.gif" usemap="#banner-map" /><map name="banner-map"><area shape="rect" coords="1,-2,616,66" href="index.htm" alt="Perl Cookbook"><area shape="rect" coords="629,-11,726,25" href="jobjects/fsearch.htm" alt="Search this book" /></map><div class="navbar"><p>
<TABLE
WIDTH="684"
BORDER="0"
CELLSPACING="0"
CELLPADDING="0"
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="228"
><A
CLASS="sect1"
HREF="ch19_04.htm"
TITLE="19.3. Fixing a 500 Server Error"
><IMG
SRC="../gifs/txtpreva.gif"
ALT="Previous: 19.3. Fixing a 500 Server Error"
BORDER="0"></A
></TD
><TD
ALIGN="CENTER"
VALIGN="TOP"
WIDTH="228"
><B
><FONT
FACE="ARIEL,HELVETICA,HELV,SANSERIF"
SIZE="-1"
><A
CLASS="chapter"
REL="up"
HREF="ch19_01.htm"
TITLE="19. CGI Programming"
></A
></FONT
></B
></TD
><TD
ALIGN="RIGHT"
VALIGN="TOP"
WIDTH="228"
><A
CLASS="sect1"
HREF="ch19_06.htm"
TITLE="19.5. Making CGI Scripts Efficient"
><IMG
SRC="../gifs/txtnexta.gif"
ALT="Next: 19.5. Making CGI Scripts Efficient"
BORDER="0"></A
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="sect1"
><H2
CLASS="sect1"
><A
CLASS="title"
NAME="ch19-37435"
>19.4. Writing a Safe CGI Program</A
></H2
><DIV
CLASS="sect2"
><H3
CLASS="sect2"
><A
CLASS="title"
NAME="ch19-pgfId-350"
>Problem<A
CLASS="indexterm"
NAME="ch19-idx-1000005425-0"
></A
><A
CLASS="indexterm"
NAME="ch19-idx-1000005425-1"
></A
></A
></H3
><P
CLASS="para"
>Because CGI programs allow external users to run programs on systems they would not otherwise have access on, all CGI programs represent a potential security risk. You want to minimize your exposure.</P
></DIV
><DIV
CLASS="sect2"
><H3
CLASS="sect2"
><A
CLASS="title"
NAME="ch19-pgfId-356"
>Solution</A
></H3
><UL
CLASS="itemizedlist"
><LI
CLASS="listitem"
><P
CLASS="para"
><A
CLASS="listitem"
NAME="ch19-pgfId-358"
></A
>Use taint mode (the <B
CLASS="emphasis.bold"
>-T</B
> switch on the #! line).</P
></LI
><LI
CLASS="listitem"
><P
CLASS="para"
><A
CLASS="listitem"
NAME="ch19-pgfId-360"
></A
>Don't blindly untaint data. (See below.)</P
></LI
><LI
CLASS="listitem"
><P
CLASS="para"
><A
CLASS="listitem"
NAME="ch19-pgfId-362"
></A
>Sanity-check everything, including all form widget return values, even hidden widgets or values generated by JavaScript code. Many people naïvely assume that just because they tell JavaScript to check the form's values before the form is submitted, the form's values will actually be checked. Not at all! The user can trivially circumvent this by disabling JavaScript in their browser, by downloading the form and altering the JavaScript, or quit by talking HTTP without a browser using any of the examples in <A
CLASS="xref"
HREF="ch20_01.htm"
TITLE="Web Automation"
>Chapter 20, <CITE
CLASS="chapter"
>Web Automation</CITE
></A
>.</P
></LI
><LI
CLASS="listitem"
><P
CLASS="para"
><A
CLASS="listitem"
NAME="ch19-pgfId-366"
></A
>Check return conditions from system calls.</P
></LI
><LI
CLASS="listitem"
><P
CLASS="para"
><A
CLASS="listitem"
NAME="ch19-pgfId-368"
></A
>Be conscious of race conditions (described below).</P
></LI
><LI
CLASS="listitem"
><P
CLASS="para"
><A
CLASS="listitem"
NAME="ch19-pgfId-370"
></A
>Run with <B
CLASS="emphasis.bold"
>-w</B
> and <CODE
CLASS="literal"
>use</CODE
> <CODE
CLASS="literal"
>strict</CODE
> to make sure Perl isn't assuming things incorrectly.</P
></LI
><LI
CLASS="listitem"
><P
CLASS="para"
><A
CLASS="listitem"
NAME="ch19-pgfId-372"
></A
>Don't run anything setuid unless you absolutely must. If you must, think about running setgid instead if you can. Certainly avoid setuid root at all costs. If you must run setuid or setgid, use a wrapper unless Perl is convinced your system has secure setuid scripts and you know what this means.</P
></LI
><LI
CLASS="listitem"
><P
CLASS="para"
><A
CLASS="listitem"
NAME="ch19-pgfId-374"
></A
>Always encode login passwords, credit card numbers, social security numbers, and anything else you'd not care to read pasted across the front page of your local newspaper. Use a secure protocol like SSL when dealing with such data.</P
></LI
></UL
></DIV
><DIV
CLASS="sect2"
><H3
CLASS="sect2"
><A
CLASS="title"
NAME="ch19-pgfId-378"
>Discussion</A
></H3
><P
CLASS="para"
>Many of these suggestions are good ideas for any program &nbsp;-  using <B
CLASS="emphasis.bold"
>-w</B
> and checking the return values of your system calls are obviously applicable even when security isn't the first thing on your mind. The <B
CLASS="emphasis.bold"
>-w</B
> switch makes Perl issue warnings about dubious constructs, like using an undefined variable as though it had a legitimate value, or writing to a read-only filehandle.</P
><P
CLASS="para"
>Apart from unanticipated shell escapes, the most common security threat lies in forged values in a form submission. It's trivial for anyone to save the source to your form, edit the HTML, and submit the altered form. Even if you're certain that a field can return only <CODE
CLASS="literal"
>&quot;yes&quot;</CODE
> or <CODE
CLASS="literal"
>&quot;no&quot;</CODE
>, they can always edit it up to return <CODE
CLASS="literal"
>&quot;maybe&quot;</CODE
> instead. Even fields marked as type <CODE
CLASS="literal"
>HIDDEN</CODE
> in the form can be tampered. If the program at the other end blindly trusts its form values, it can be fooled into deleting files, creating new user accounts, mailing password or credit card databases, or innumerable other malicious abuses. This is why you must never blindly trust data (like prices) stored in hidden fields when writing CGI shopping cart applications.</P
><P
CLASS="para"
>Even worse is when the CGI script uses a form value as the basis of a filename to open or a command to run. Bogus values submitted to the script could trick it into opening arbitrary files. Situations like this are precisely why Perl has a taint mode. If a program runs setuid, or else has the <B
CLASS="emphasis.bold"
>-T</B
> switch active, any data coming in through program arguments, environment variables, directory listings, or a file, are considered tainted, and cannot be used directly or indirectly to affect the outside world.</P
><P
CLASS="para"
>Running under <A
CLASS="indexterm"
NAME="ch19-idx-1000005440-0"
></A
>taint mode, Perl insists that you set your path variable first, even if specifying a complete pathname when you call a program. That's because you have no assurance that the command you run won't turn around and invoke some other program using a relative pathname. You must also untaint any externally derived data for safety.</P
><P
CLASS="para"
>For instance, when running in taint mode:</P
><PRE
CLASS="programlisting"
>#!/usr/bin/perl -T
open(FH, &quot;&gt; $ARGV[0]&quot;) or die;</PRE
><P
CLASS="para"
>Perl warns with:</P
><PRE
CLASS="programlisting"
><CODE
CLASS="userinput"
><B
><CODE
CLASS="replaceable"
><I
>Insecure dependency in open while running with -T switch at ...</I
></CODE
></B
></CODE
></PRE
><P
CLASS="para"
>This is because <CODE
CLASS="literal"
>$ARGV[0]</CODE
> (having come from outside your program) is not trustworthy. The only way to change tainted data into untainted data is by using regular expression backreferences:</P
><PRE
CLASS="programlisting"
>$file = $ARGV[0];                                   # $file tainted
unless ($file =~ m#^([\w.-]+)$#) {                  # $1 is untainted
    die &quot;filename '$file' has invalid characters.\n&quot;;
}
$file = $1;                                         # $file untainted</PRE
><P
CLASS="para"
>Tainted data can come from anything outside your program, such as from your program arguments or environment variables, the results of reading from filehandles or directory handles, and <CODE
CLASS="literal"
>stat</CODE
> or locale information. Operations considered insecure with tainted data include <CODE
CLASS="literal"
>system(STRING)</CODE
>, <CODE
CLASS="literal"
>exec(STRING)</CODE
>, backticks, <CODE
CLASS="literal"
>glob</CODE
>, <CODE
CLASS="literal"
>open</CODE
> with any mode except read-only, <CODE
CLASS="literal"
>unlink</CODE
>, <CODE
CLASS="literal"
>mkdir</CODE
>, <CODE
CLASS="literal"
>rmdir</CODE
>, <CODE
CLASS="literal"
>chown</CODE
>, <CODE
CLASS="literal"
>chmod</CODE
>, <CODE
CLASS="literal"
>umask</CODE
>, <CODE
CLASS="literal"
>link</CODE
>, <CODE
CLASS="literal"
>symlin</CODE
>k, the <B
CLASS="emphasis.bold"
>-s</B
> command-line switch, <CODE
CLASS="literal"
>kill</CODE
>, <CODE
CLASS="literal"
>require</CODE
>, <CODE
CLASS="literal"
>eval</CODE
>, <CODE
CLASS="literal"
>truncate</CODE
>, <CODE
CLASS="literal"
>ioctl</CODE
>, <CODE
CLASS="literal"
>fcntl</CODE
>, <CODE
CLASS="literal"
>socket</CODE
>, <CODE
CLASS="literal"
>socketpair</CODE
>, <CODE
CLASS="literal"
>bind</CODE
>, <CODE
CLASS="literal"
>connect</CODE
>, <CODE
CLASS="literal"
>chdir</CODE
>, <CODE
CLASS="literal"
>chroot</CODE
>, <CODE
CLASS="literal"
>setpgrp</CODE
>, <CODE
CLASS="literal"
>setpriority</CODE
>, and <CODE
CLASS="literal"
>syscall</CODE
>.</P
><P
CLASS="para"
>A common attack exploits what's known as a <EM
CLASS="emphasis"
>race condition</EM
><A
CLASS="indexterm"
NAME="ch19-idx-1000005439-0"
></A
>. That's a situation where, between two actions of yours, an attacker can race in and change something to make your program misbehave. A notorious race condition occurred in the way older Unix kernels ran setuid scripts: between the kernel reading the file to find which interpreter to run, and the now-setuid interpreter reading the file, a malicious person could substitute their own script.</P
><P
CLASS="para"
>Race conditions crop up even in apparently innocuous places. Consider what would happen if not one but many copies of the following code ran simultaneously.</P
><PRE
CLASS="programlisting"
>unless (-e $filename) {                     # WRONG!
    open(FH, &quot;&gt; $filename&quot;);
    # ...
}</PRE
><P
CLASS="para"
>There's a race between testing whether the file exists and opening it for writing. Still worse, if someone replaced the file with a link to something important, like one of your personal configuration files, the above code would erase that file. The correct way to do this is to do a non-destructive create with the <CODE
CLASS="literal"
>sysopen</CODE
> function, described in <A
CLASS="xref"
HREF="ch07_02.htm"
TITLE="Opening a File"
>Recipe 7.1</A
>.</P
><P
CLASS="para"
>A setuid CGI script runs with different permissions than the web server does. This lets the CGI script access resources (files, shadow password databases, etc) that it otherwise could not. This can be convenient, but it can also be dangerous. Weaknesses in setuid scripts may let crackers access not only files that the low-privilege web server user can access, but also any that could be accessed by the user the script runs as. For a poorly written setuid root script, this could let anyone change passwords, delete files, read credit card records, and other malicious acts. This is why you should always make sure your programs run with the lowest possible privilege, normally the user the web server runs as: <CODE
CLASS="literal"
>nobody</CODE
>.</P
><P
CLASS="para"
>Finally (and this recommendation may be the hardest to follow) be conscious of the physical path your network traffic takes. Are you sending passwords over an unencrypted connection? Do these unencrypted passwords travel through insecure networks? A form's PASSWORD input field only protects you from someone looking over your shoulder. Always use SSL when real passwords are involved. If you're serious about security, fire up your browser and a packet sniffer to see how easily your traffic is decoded. <A
CLASS="indexterm"
NAME="ch19-idx-1000005427-0"
></A
><A
CLASS="indexterm"
NAME="ch19-idx-1000005427-1"
></A
></P
></DIV
><DIV
CLASS="sect2"
><H3
CLASS="sect2"
><A
CLASS="title"
NAME="ch19-pgfId-432"
>See Also</A
></H3
><P
CLASS="para"
>The section on 
<A
CLASS="olink"
HREF="../prog/ch06_03.htm"
>&#13;"Cooperating with Strangers"</A
> 
in <A
CLASS="olink"
HREF="../prog/ch06_01.htm"
>Chapter 6</A
> of <A
CLASS="citetitle"
HREF="../prog/index.htm"
TITLE="Programming Perl"
><CITE
CLASS="citetitle"
>Programming Perl</CITE
></A
>; <I
CLASS="filename"
>perlsec </I
>(1); the CGI and HTTP specs and the CGI Security FAQ, all mentioned in the Introduction to this chapter; the section on "Avoiding Denial of Service Attacks" in the standard CGI module documentation; <A
CLASS="xref"
HREF="ch19_07.htm"
TITLE="Executing Commands Without Shell Escapes"
>Recipe 19.6</A
></P
></DIV
></DIV
><DIV
CLASS="htmlnav"
><P
></P
><HR
ALIGN="LEFT"
WIDTH="684"
TITLE="footer"><TABLE
WIDTH="684"
BORDER="0"
CELLSPACING="0"
CELLPADDING="0"
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="228"
><A
CLASS="sect1"
HREF="ch19_04.htm"
TITLE="19.3. Fixing a 500 Server Error"
><IMG
SRC="../gifs/txtpreva.gif"
ALT="Previous: 19.3. Fixing a 500 Server Error"
BORDER="0"></A
></TD
><TD
ALIGN="CENTER"
VALIGN="TOP"
WIDTH="228"
><A
CLASS="book"
HREF="index.htm"
TITLE="Perl Cookbook"
><IMG
SRC="../gifs/txthome.gif"
ALT="Perl Cookbook"
BORDER="0"></A
></TD
><TD
ALIGN="RIGHT"
VALIGN="TOP"
WIDTH="228"
><A
CLASS="sect1"
HREF="ch19_06.htm"
TITLE="19.5. Making CGI Scripts Efficient"
><IMG
SRC="../gifs/txtnexta.gif"
ALT="Next: 19.5. Making CGI Scripts Efficient"
BORDER="0"></A
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="228"
>19.3. Fixing a 500 Server Error</TD
><TD
ALIGN="CENTER"
VALIGN="TOP"
WIDTH="228"
><A
CLASS="index"
HREF="index/index.htm"
TITLE="Book Index"
><IMG
SRC="../gifs/index.gif"
ALT="Book Index"
BORDER="0"></A
></TD
><TD
ALIGN="RIGHT"
VALIGN="TOP"
WIDTH="228"
>19.5. Making CGI Scripts Efficient</TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="684"
TITLE="footer"><FONT
SIZE="-1"
></DIV<!-- LIBRARY NAV BAR --> <img src="../gifs/smnavbar.gif" usemap="#library-map" border="0" alt="Library Navigation Links"><p> <a href="copyrght.htm">Copyright &copy; 2002</a> O'Reilly &amp; Associates. All rights reserved.</font> </p> <map name="library-map"> <area shape="rect" coords="1,0,85,94" href="../index.htm"><area shape="rect" coords="86,1,178,103" href="../lwp/index.htm"><area shape="rect" coords="180,0,265,103" href="../lperl/index.htm"><area shape="rect" coords="267,0,353,105" href="../perlnut/index.htm"><area shape="rect" coords="354,1,446,115" href="../prog/index.htm"><area shape="rect" coords="448,0,526,132" href="../tk/index.htm"><area shape="rect" coords="528,1,615,119" href="index.htm"><area shape="rect" coords="617,0,690,135" href="../pxml/index.htm"></map> </BODY
></HTML
>
